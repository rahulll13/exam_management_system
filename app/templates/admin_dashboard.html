<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - ExamCell Pro</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        /* --- 1. GLOBAL RESET & VARS --- */
        
         :root {
            --sidebar-width: 260px;
            --primary-color: #6366f1;
            --bg-color: #f3f4f6;
            --text-color: #333;
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: "Inter", sans-serif;
            background: var(--bg-color);
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            display: flex;
            overflow: hidden;
        }
        /* --- 2. SIDEBAR --- */
        
        .sidebar {
            width: var(--sidebar-width);
            height: 100%;
            background: #1e1e2f;
            color: white;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            overflow-y: auto;
            padding: 20px;
            z-index: 100;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 40px;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .nav-item {
            padding: 12px 15px;
            margin-bottom: 5px;
            color: #a0a0b0;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: 0.2s;
        }
        
        .nav-item:hover,
        .nav-item.active {
            background: var(--primary-color);
            color: white;
        }
        
        .nav-spacer {
            flex-grow: 1;
        }
        /* --- 3. MAIN CONTENT --- */
        
        .main-content {
            flex: 1;
            height: 100%;
            overflow-y: auto;
            padding: 40px;
            position: relative;
            background: var(--bg-color);
            display: block;
        }
        
        .content-section {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        #room-section {
            display: block;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        /* --- 4. COMPONENT STYLES --- */
        
        h2 {
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 10px;
            margin-bottom: 30px;
            color: var(--text-color);
        }
        
        .card {
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
            width: 100%;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        input,
        select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
            outline: none;
        }
        
        input:focus,
        select:focus {
            border-color: var(--primary-color);
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            color: white;
            transition: 0.2s;
            display: inline-block;
        }
        
        .btn:hover {
            opacity: 0.9;
        }
        
        .btn-primary {
            background: var(--primary-color);
        }
        
        .btn-warning {
            background: #f59e0b;
            color: white;
        }
        
        .btn-danger {
            background: #ef4444;
        }
        
        .btn-dark {
            background: #1f2937;
        }
        
        .btn-success {
            background: #10b981;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
        }
        /* Tables */
        
        .duty-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .duty-table th,
        .duty-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .duty-table th {
            background-color: #f8f9fa;
            color: #555;
        }
        /* Layout Designer Grid */
        
        #layout-preview {
            display: grid;
            gap: 5px;
            margin-top: 15px;
            margin-bottom: 20px;
            justify-content: center;
        }
        
        .layout-box {
            width: 40px;
            height: 40px;
            background: #10b981;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.7rem;
            user-select: none;
        }
        
        .layout-box.disabled {
            background: #e5e7eb;
            color: #ccc;
        }
        /* --- VISUAL CHART CSS --- */
        
        .visual-grid {
            display: grid !important;
            gap: 10px;
            margin-top: 15px;
            width: 100%;
            background: #fdfbf7;
            padding: 15px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            min-height: 200px;
        }
        
        .seat-box {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 5px;
            border-radius: 6px;
            font-size: 0.8rem;
            min-height: 80px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            background: white;
            border: 1px solid #ddd;
            text-align: center;
        }
        
        .chart-wrapper {
            margin-bottom: 40px;
            border: 1px solid #eee;
            padding: 15px;
            border-radius: 8px;
            background: #fafafa;
        }
        
        .badge {
            display: inline-block;
            padding: 0.35em 0.65em;
            font-size: 0.75em;
            font-weight: 700;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 0.25rem;
        }
        /* Print Specifics */
        
        .notice-container,
        .att-sheet,
        .master-container,
        #distribution-preview {
            display: none;
        }
        
        @media print {
            body {
                display: block !important;
                background: white !important;
                padding: 0 !important;
                margin: 0 !important;
                height: auto !important;
                overflow: visible !important;
            }
            .sidebar,
            .main-content>.card,
            .main-content>h2,
            .main-content>datalist {
                display: none !important;
            }
            .notice-container,
            .att-sheet,
            .master-container,
            #distribution-preview {
                display: block !important;
                width: 100% !important;
                margin: 0 !important;
            }
            /* --- ATTENDANCE SHEET SPECIFIC PRINT CSS --- */
            .att-page-break {
                page-break-after: always;
            }
            @page {
                margin-top: 0;
                margin-bottom: 0;
            }
        }
        /* NOTICE TABLE SPECIFIC CSS (Matches PDF) */
        
        .notice-table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'Times New Roman', Times, serif;
            font-size: 14px;
            color: #000;
        }
        
        .notice-table th,
        .notice-table td {
            border: 1px solid #000;
            padding: 5px 8px;
            text-align: left;
            vertical-align: middle;
        }
        
        .notice-table th {
            text-align: center;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .text-center {
            text-align: center !important;
        }
        
        .text-right {
            text-align: right !important;
        }
        
        .font-bold {
            font-weight: bold;
        }
        
        .no-border-right {
            border-right: none !important;
        }
        
        .no-border-left {
            border-left: none !important;
        }
        
        .notice-header {
            text-align: center;
            margin-bottom: 20px;
            font-family: 'Times New Roman', Times, serif;
        }
        
        .notice-header h1 {
            font-size: 24px;
            font-weight: bold;
            margin: 0 0 5px 0;
            text-decoration: none;
        }
        
        .notice-header h2 {
            font-size: 16px;
            font-weight: bold;
            margin: 5px 0;
            border: none;
            padding: 0;
            text-transform: uppercase;
        }
        
        .notice-header p {
            margin: 5px 0;
            font-size: 14px;
            font-weight: bold;
        }
        
        .notice-footer {
            margin-top: 20px;
            font-family: 'Times New Roman', Times, serif;
            font-size: 12px;
        }
        
        .notice-footer .note-title {
            text-decoration: underline;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .notice-footer ol {
            margin: 0;
            padding-left: 20px;
        }
        
        .notice-footer li {
            margin-bottom: 4px;
        }
        
        .copy-to {
            margin-top: 15px;
        }
        
        .sign-area {
            margin-top: 30px;
            text-align: right;
            font-weight: bold;
        }
        /* --- ATTENDANCE SHEET CSS (Matches provided PDF exactly) --- */
        
        .att-sheet-container {
            font-family: 'Times New Roman', serif;
            background: white;
            padding: 20px;
            color: black;
            width: 100%;
        }
        
        .att-top-header {
            width: 100%;
            margin-bottom: 5px;
        }
        
        .att-top-header td {
            vertical-align: top;
            font-weight: bold;
            font-size: 14px;
        }
        
        .att-title-main {
            text-align: center;
            font-weight: bold;
            text-decoration: underline;
            font-size: 16px;
            margin: 5px 0;
            text-transform: uppercase;
        }
        
        .att-hall-details {
            width: 100%;
            border: 1px solid #000;
            margin-bottom: 10px;
            padding: 5px;
            font-weight: bold;
            font-size: 13px;
        }
        
        .att-hall-details td {
            padding: 2px 10px;
        }
        
        .att-info-block {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
            line-height: 1.5;
            text-align: center;
        }
        
        .att-real-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        
        .att-real-table th,
        .att-real-table td {
            border: 1px solid black;
            padding: 5px;
            text-align: center;
            vertical-align: middle;
        }
        
        .att-real-table th {
            background-color: #f2f2f2;
            text-transform: uppercase;
            font-weight: bold;
        }
        
        .att-bottom-footer {
            margin-top: 40px;
            display: flex;
            justify-content: space-between;
            font-weight: bold;
            font-size: 14px;
            padding-bottom: 20px;
        }
    </style>
</head>

<body>
    <div class="sidebar">
        <div class="logo"><i class="fas fa-shield-alt"></i> ExamControl</div>
        <div class="nav-item active" onclick="showSection('room-section')"><i class="fas fa-door-open"></i> Manage Rooms
        </div>
        <div class="nav-item" onclick="showSection('student-section')"><i class="fas fa-user-graduate"></i> Manage Students
        </div>
        <div class="nav-item" onclick="showSection('seating-section')"><i class="fas fa-users-cog"></i> Generate Seating
        </div>
        <div class="nav-item" onclick="showSection('chart-section')"><i class="fas fa-th"></i> View Seating Chart</div>
        <div class="nav-item" onclick="showSection('notice-section')"><i class="fas fa-clipboard-list"></i> Seat Plan Notice
        </div>
        <div class="nav-item" onclick="showSection('attendance-section')"><i class="fas fa-file-signature"></i> Attendance Sheet</div>
        <div class="nav-item" onclick="showSection('distribution-section')"><i class="fas fa-file-invoice"></i> Question Distribution
        </div>
        <div class="nav-item" onclick="showSection('master-chart-section')"><i class="fas fa-table"></i> Master Chart
        </div>
        <div class="nav-item" onclick="showSection('ai-section')"><i class="fas fa-brain"></i> AI Model Training</div>
        <div class="nav-item" onclick="showSection('teacher-section')"><i class="fas fa-chalkboard-teacher"></i> Teachers & Duties</div>
        <div class="nav-item" onclick="showSection('settings-section')"><i class="fas fa-cogs"></i> Settings & Reset
        </div>
        <div class="nav-spacer"></div>
        <div class="nav-item" onclick="resetSystem()" style="color: #ef4444; border-top: 1px solid #333; margin-top: 10px;"><i class="fas fa-trash-alt"></i> Quick Reset
        </div>
        <div class="nav-item" style="color: #ff6b6b" onclick="location.href='/api/landing'"><i class="fas fa-sign-out-alt"></i> Logout</div>
    </div>

    <div class="main-content">
        <datalist id="time_options">
            <option value="10:00 AM to 01:00 PM (1st Sitting)"></option>
            <option value="10:00 AM to 11:30 AM (1st Sitting)"></option>
            <option value="02:00 PM to 05:00 PM (2nd Sitting)"></option>
        </datalist>

        <datalist id="batch_options">
            <option value="2022-2026"></option>
            <option value="2023-2027"></option>
            <option value="2024-2028"></option>
            <option value="2025-2029"></option>
        </datalist>

        <div id="room-section" class="content-section">
            <h2>Manage Examination Halls</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                <div class="card" style="background: #eff6ff; border: 1px solid #bfdbfe; color: #1e40af; display: flex; align-items: center; justify-content: space-between;">
                    <div>
                        <div style="font-weight: bold;">Total Rooms</div>
                        <div style="font-size: 2rem; font-weight: 800;" id="total-rooms-display">0</div>
                    </div>
                    <i class="fas fa-door-open" style="font-size: 2.5rem; opacity: 0.2;"></i>
                </div>
                <div class="card" style="background: #f0fdf4; border: 1px solid #bbf7d0; color: #166534; display: flex; align-items: center; justify-content: space-between;">
                    <div>
                        <div style="font-weight: bold;">Total Capacity</div>
                        <div style="font-size: 2rem; font-weight: 800;" id="total-capacity-display">0</div>
                    </div>
                    <i class="fas fa-chair" style="font-size: 2.5rem; opacity: 0.2;"></i>
                </div>
            </div>

            <div class="card">
                <h4 class="mb-3 text-primary">Add New Room (Layout Designer)</h4>
                <form id="addRoomForm" onsubmit="addRoom(event)">
                    <div class="form-grid">
                        <div><label>Building Name</label><input type="text" id="building_name" placeholder="e.g. Science Block" required /></div>
                        <div><label>Room Name</label><input type="text" id="room_name" placeholder="e.g. Hall 101" required /></div>
                    </div>
                    <div class="form-grid">
                        <div><label>Max Rows</label><input type="number" id="rows" value="10" required /></div>
                        <div><label>Max Columns</label><input type="number" id="cols" value="6" required /></div>
                    </div>
                    <button type="button" class="btn btn-dark w-100 mb-3" onclick="generateLayoutGrid()">Step 1:
                        Generate Grid</button>
                    <div id="layout-container" style="display: none">
                        <p class="text-center text-muted small">Click seats to Disable/Enable (Gray = Empty Space)</p>
                        <div id="layout-preview" style="justify-content: center"></div>
                        <button type="submit" class="btn btn-primary w-100 mt-3">Step 2: Save Room</button>
                    </div>
                </form>
            </div>

            <div class="card" style="border-left: 5px solid #f59e0b">
                <h4 style="color: #d97706; margin-top: 0">Edit Room Dimensions</h4>
                <form id="editRoomForm" onsubmit="updateRoom(event)">
                    <div class="form-grid">
                        <div style="grid-column: span 2">
                            <label>Select Room to Edit</label>
                            <select id="edit_room_id" required>
                                <option value="">-- Select Room --</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-grid">
                        <div><label>New Rows</label><input type="number" id="edit_rows" required /></div>
                        <div><label>New Columns</label><input type="number" id="edit_cols" required /></div>
                    </div>
                    <button type="submit" class="btn btn-warning">Update Dimensions</button>
                </form>
                <div id="edit-notification" style="margin-top:10px;"></div>
            </div>

            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h4 class="text-secondary" style="margin:0;">üìã Room Directory</h4>
                    <button onclick="loadRooms()" class="btn btn-sm btn-outline-dark"><i class="fas fa-sync"></i>
                        Refresh</button>
                </div>
                <table class="duty-table">
                    <thead>
                        <tr>
                            <th>Building</th>
                            <th>Room</th>
                            <th>Capacity</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="room-list-body"></tbody>
                </table>
            </div>
        </div>

        <div id="student-section" class="content-section">
            <h2>Manage Students</h2>
            <div class="card border-start border-4 border-warning mt-4" style="background-color: #fffbeb;">
                <h3 class="text-warning" style="margin-top:0;"><i class="fas fa-users-slash"></i> Bulk Delete by Batch
                </h3>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="delete_batch_input" placeholder="Enter Batch (e.g. 2024-2028)" style="max-width: 300px;">
                    <button onclick="deleteBatch()" class="btn btn-warning text-white">Delete Batch</button>
                </div>
            </div>

            <div class="card">
                <h3><i class="fas fa-file-csv"></i> Bulk Upload Students</h3>
                <form onsubmit="uploadCSV(event)">
                    <input type="file" id="csv_file" accept=".csv" required style="margin-bottom:15px;" />
                    <button type="submit" class="btn btn-primary">Upload Students</button>
                </form>
                <div id="upload-status"></div>
            </div>
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3><i class="fas fa-users"></i> Student Database</h3>
                    <button onclick="toggleStudentForm(true)" class="btn btn-success"><i class="fas fa-plus"></i> Add
                        New Student</button>
                </div>

                <div id="student-form-container" style="display: none; background: #f9fafb; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 id="form-title" style="margin-top: 0; color: #4f46e5">Add Student</h4>
                    <form onsubmit="handleStudentSave(event)">
                        <input type="hidden" id="stud_id" />
                        <div class="form-grid">
                            <div><label>Full Name</label><input type="text" id="stud_name" required /></div>
                            <div><label>Registration Number</label><input type="text" id="stud_reg" placeholder="Leave empty if temporary" /></div>
                        </div>
                        <div class="form-grid">
                            <div><label>Roll Number</label><input type="text" id="stud_roll" required /></div>
                            <div><label>Branch</label><input type="text" id="stud_branch" required /></div>
                        </div>
                        <div class="form-grid">
                            <div><label>Batch/Session</label><input type="text" id="stud_session" list="batch_options" required /></div>
                            <div>
                                <label>Course</label>
                                <select id="stud_course" required>
                                    <option value="B.Tech" selected>B.Tech</option>
                                    <option value="M.Tech">M.Tech</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary" id="save-btn">Save Student</button>
                        <button type="button" class="btn btn-dark" onclick="toggleStudentForm()">Cancel</button>
                    </form>
                </div>

                <div class="row" style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <input type="text" id="student_search" placeholder="Search name/roll/reg..." onkeyup="filterStudents()" style="flex: 2; padding:10px;">
                    <select id="filter_session" onchange="filterStudents()" style="flex: 1; padding:10px;">
                        <option value="">-- All Sessions --</option>
                    </select>
                    <div style="flex: 0 0 auto; display: flex; align-items: center;">
                        <input type="checkbox" id="filter_missing_reg" onchange="filterStudents()" style="width: 20px; height: 20px; margin-right: 8px; cursor: pointer;">
                        <label for="filter_missing_reg" style="cursor: pointer; margin: 0; font-size: 0.9rem; color: #d97706; font-weight: bold;">Show
                            Temp Only</label>
                    </div>
                </div>
                <div style="overflow-x: auto; max-height: 500px; overflow-y: auto">
                    <table class="duty-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Reg No</th>
                                <th>Roll No</th>
                                <th>Course</th>
                                <th>Branch</th>
                                <th>Batch</th>
                                <th style="min-width: 120px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="student-table-body">
                            <tr>
                                <td colspan="7" class="text-center">Loading students...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="seating-section" class="content-section">
            <h2>Auto-Generate Seating</h2>
            <div class="card">
                <form id="seatingForm" onsubmit="generateSeating(event)">
                    <div class="form-grid">
                        <div>
                            <label>Select Room</label>
                            <select id="target_room_id" required onchange="toggleBranchMapping()">
                                <option value="">-- Loading... --</option>
                            </select>
                        </div>
                        <div id="room-branch-mapping-container" style="display: none; border: 1px solid #ddd; padding: 15px; background: #f9f9f9; border-radius: 8px;">
                            <label style="color: #333; margin-bottom: 10px; display: block">üëá Define Branches for Each
                                Room (Optional)</label>
                            <div id="room-mapping-list" style="max-height: 300px; overflow-y: auto;"></div>
                        </div>
                        <div><label>Exam Name</label><input type="text" id="exam_name" required /></div>
                    </div>
                    <div class="form-grid">
                        <div><label>Exam Date</label><input type="date" id="exam_date" required /></div>
                        <div><label>Time Slot</label><input type="text" id="exam_time" list="time_options" required />
                        </div>
                    </div>
                    <div class="form-grid">
                        <div><label>Select Batch</label><input type="text" id="target_session" list="batch_options" required /></div>
                        <div>
                            <label>Course</label>
                            <select id="gen_course" onchange="updateStats()">
                                <option value="B.Tech" selected>B.Tech</option>
                                <option value="M.Tech">M.Tech</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label>Semester</label>
                        <select id="gen_semester" required>
                            <option value="1st Sem">1st Sem</option>
                            <option value="2nd Sem">2nd Sem</option>
                            <option value="3rd Sem">3rd Sem</option>
                            <option value="4th Sem">4th Sem</option>
                            <option value="5th Sem">5th Sem</option>
                            <option value="6th Sem">6th Sem</option>
                            <option value="7th Sem">7th Sem</option>
                            <option value="8th Sem">8th Sem</option>
                        </select>
                    </div>
                    <div style="margin-top: 15px; margin-bottom: 15px;">
                        <label>Select Branches (Order determines Priority)</label>
                        <div id="branch-checkbox-container" style="display: flex; flex-wrap: wrap; gap: 8px; padding: 10px; background: #fff; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px;">
                            <span class="text-muted small">Loading branches...</span>
                        </div>
                        <div style="background: #f8fafc; padding: 8px; border: 1px solid #e2e8f0; font-size: 0.9rem;">
                            <strong>Selected Sequence:</strong> <span id="priority-display" style="color: #2563eb; font-weight: bold;">None</span>
                        </div>
                        <input type="hidden" id="branches_input" value="ALL">
                        <div style="margin-top:5px;">
                            <button type="button" class="btn btn-dark btn-sm" onclick="selectAllBranches()">Select
                                All</button>
                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="clearBranches()">Clear</button>
                        </div>
                    </div>
                    <div class="form-grid">
                        <div><label>Max Branches Per Room</label><input type="number" id="max_branches_limit" value="10" min="1" /></div>
                    </div>
                    <div style="background: #e0f2fe; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4><i class="fas fa-calculator"></i> Live Availability</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9rem;">
                            <div><strong>Capacity:</strong> <span id="stat_room_cap">-</span></div>
                            <div><strong>Selected:</strong> <span id="stat_selected">0</span></div>
                            <div><strong>Status:</strong> <span id="stat_status">Waiting...</span></div>
                        </div>
                        <div id="stat_breakdown" style="margin-top: 5px;"></div>
                    </div>
                    <button type="submit" class="btn btn-success w-100">Run Seating Algorithm</button>
                </form>
                <div id="seating-result" style="margin-top: 15px; font-weight: bold;"></div>
            </div>
        </div>

        <div id="chart-section" class="content-section">
            <h2>Visual Seating Arrangement</h2>
            <div class="card">
                <div class="form-grid">
                    <div>
                        <label>Select Course</label>
                        <select id="chart_course">
                            <option value="B.Tech" selected>B.Tech</option>
                            <option value="M.Tech">M.Tech</option>
                        </select>
                    </div>
                    <div>
                        <label>Select Room</label>
                        <select id="chart_room_id" onchange="fetchExamsForRoom()">
                            <option value="">-- Loading... --</option>
                        </select>
                    </div>
                    <div>
                        <label>Select Session</label>
                        <select id="chart_exam_id" disabled>
                            <option>-- Select Room First --</option>
                        </select>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button onclick="loadChart()" class="btn btn-primary" style="flex: 1"><i class="fas fa-search"></i>
                        Load Real Data</button>
                    <button onclick="downloadPDF()" class="btn btn-dark" style="flex: 1"><i class="fas fa-file-pdf"></i>
                        Download PDF</button>
                </div>

                <div id="seating-grid">
                    <p style="text-align:center; padding-top: 50px; color:#999;">Select options above to generate the view.
                    </p>
                </div>
            </div>
        </div>

        <div id="notice-section" class="content-section">
            <h2>Print Seating Plan Notice</h2>
            <div class="card">
                <div class="form-grid">
                    <div>
                        <label style="color: #6366f1; font-weight: bold;">Select Exam Event (Source Data)</label>
                        <select id="notice_exam_id">
                            <option value="">-- Select Exam to Load --</option>
                        </select>
                    </div>
                    <div><label>Room (Optional)</label><select id="notice_room_id" onchange="fetchExamsForNotice()">
                            <option value="">-- All Rooms (Campus Notice) --</option>
                        </select></div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top: 15px;">
                    <div><label>Course (Header)</label><select id="notice_course">
                            <option value="B.Tech">B.Tech</option>
                            <option value="M.Tech">M.Tech</option>
                        </select></div>
                    <div><label>Date (Header)</label><input type="date" id="notice_date" /></div>
                    <div><label>Time (Header)</label><input type="text" id="notice_time" list="time_options" /></div>
                    <div><label>Batch (Header)</label><input type="text" id="notice_batch" list="batch_options" /></div>
                    <div><label>Semester (Header)</label><select id="notice_semester">
                            <option value="1st">1st</option>
                            <option value="2nd">2nd</option>
                            <option value="3rd">3rd</option>
                            <option value="4th">4th</option>
                            <option value="5th">5th</option>
                            <option value="6th">6th</option>
                            <option value="7th">7th</option>
                            <option value="8th">8th</option>
                        </select></div>
                </div>

                <div style="margin-top:15px;">
                    <button class="btn btn-primary" onclick="generateNotice()">Generate Notice Preview</button>
                    <button class="btn btn-dark" onclick="downloadNoticePDF()"><i class="fas fa-file-pdf"></i> Download
                        PDF</button>
                </div>
            </div>

            <div id="notice-container" class="card" style="display: none; padding: 40px; border: 1px solid #ddd; border-radius: 4px; box-shadow: none;">
                <div class="notice-header">
                    <h1>BIT SINDRI</h1>
                    <h2 id="notice-title-display"></h2>
                    <p>TIMING: <span id="notice-timing-display"></span></p>
                </div>

                <table class="notice-table">
                    <thead>
                        <tr>
                            <th style="width: 15%">BRANCH</th>
                            <th style="width: 40%">REGISTRATION NUMBER</th>
                            <th style="width: 15%">COUNT</th>
                            <th style="width: 30%">HALL NO.</th>
                        </tr>
                    </thead>
                    <tbody id="notice-body"></tbody>
                    <tfoot>
                        <tr>
                            <td colspan="4" style="text-align: right; font-weight: bold; border-top: 2px solid #000;">
                                GRAND TOTAL = <span id="notice-grand-total">0</span>
                            </td>
                        </tr>
                    </tfoot>
                </table>

                <div class="notice-footer">
                    <div class="note-title">Note:</div>
                    <ol>
                        <li>Examinees are required to bring their properly updated "LIBRARY CARD/ COLLEGE ADMISSION RECEIPT/IDENTITY CARD" on each day of examination, without which he/she may not be allowed to appear.</li>
                        <li>Mobile phone/ Smart Watch are strictly prohibited. Keeping mobile phone during the exam, may lead scratching of the answer sheet or Unfair Means.</li>
                        <li>After 15 minutes of commencement of examination, No Examinee will be allowed to enter the Examination Hall.</li>
                        <li>Answer sheet submission will be allowed only after 45 minutes.</li>
                    </ol>
                    <div class="copy-to">
                        <strong>Copy to:</strong> 1) Concerned Head of the Departments; 2) Dean (Academic); 3) Main Notice Board; 4) PA to Director, BIT Sindri for information.
                    </div>
                    <div class="sign-area">
                        <br><br> Prof. In Charge, Exam<br> BIT Sindri.
                    </div>
                </div>
            </div>
        </div>

        <div id="attendance-section" class="content-section">
            <h2>Generate Attendance Sheet</h2>
            <div class="card">
                <div class="form-grid">
                    <div><label>Course</label><select id="att_course">
                            <option value="B.Tech">B.Tech</option>
                            <option value="M.Tech">M.Tech</option>
                        </select></div>
                    <div><label>Batch</label><input type="text" id="att_batch" list="batch_options" /></div>
                    <div><label>Semester</label><select id="att_semester">
                            <option value="1st Sem">1st Sem</option>
                            <option value="2nd Sem">2nd Sem</option>
                            <option value="3rd Sem">3rd Sem</option>
                            <option value="4th Sem">4th Sem</option>
                            <option value="5th Sem">5th Sem</option>
                            <option value="6th Sem">6th Sem</option>
                            <option value="7th Sem">7th Sem</option>
                            <option value="8th Sem">8th Sem</option>
                        </select></div>
                    <div><label>Date</label><input type="date" id="att_date" /></div>
                    <div><label>Time</label><input type="text" id="att_time" list="time_options" /></div>
                    <div><label>Room (Hall No)</label><select id="att_room_id">
                            <option value="">-- Select Room --</option>
                        </select></div>
                    <div>
                        <label>No. of Exams/Subjects</label>
                        <select id="att_subject_count">
                            <option value="1">1 (Single Exam)</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="generateAttendance()">Generate</button>
                <button class="btn btn-dark" onclick="printSection('attendance-preview')">Print</button>
            </div>
            <div id="attendance-preview" class="att-sheet"></div>
        </div>

        <div id="distribution-section" class="content-section">
            <h2>Question Paper Distribution</h2>
            <div class="card">
                <div class="form-grid">
                    <div><label>Course</label><select id="dist_course">
                            <option value="B.Tech">B.Tech</option>
                            <option value="M.Tech">M.Tech</option>
                        </select></div>
                    <div><label>Batch</label><input type="text" id="dist_batch" list="batch_options" /></div>
                    <div><label>Date</label><input type="date" id="dist_date" /></div>
                    <div><label>Time</label><input type="text" id="dist_time" list="time_options" /></div>
                </div>
                <button class="btn btn-primary" onclick="generateDistribution()">Generate</button>
                <button class="btn btn-dark" onclick="printSection('distribution-preview')">Print</button>
            </div>

            <div id="distribution-preview" style="background: white; padding: 40px; margin-top: 20px; font-family: 'Times New Roman', serif; color: black; display: none;">
                <div style="text-align: center; margin-bottom: 20px;">
                    <h1 style="margin: 0; font-size: 24px; font-weight: bold; text-decoration: underline;">B.I.T, SINDRI
                    </h1>
                    <h3 id="dist-print-title" style="margin: 5px 0; font-size: 16px; font-weight: bold;"></h3>
                    <p style="margin: 2px 0; font-size: 14px;">(JUT Ranchi)</p>
                    <p id="dist-print-timing" style="margin: 5px 0; font-size: 14px; font-weight: bold;"></p>
                </div>

                <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                    <thead>
                        <tr style="background: #f0f0f0;">
                            <th style="border: 1px solid black; padding: 8px; width: 10%; text-align: center;">SL. NO.
                            </th>
                            <th style="border: 1px solid black; padding: 8px; width: 20%; text-align: left;">BRANCH</th>
                            <th style="border: 1px solid black; padding: 8px; text-align: left;">HALL NO. & QUANTITY
                            </th>
                        </tr>
                    </thead>
                    <tbody id="dist-body">
                    </tbody>
                </table>

                <div style="margin-top: 30px; text-align: right; font-weight: bold;">
                    <br><br> Prof. In Charge, Exam<br> BIT Sindri
                </div>
            </div>
        </div>

        <div id="master-chart-section" class="content-section">
            <h2>Master Seating Chart</h2>
            <div class="card">
                <div class="form-grid">
                    <div><label>Date</label><input type="date" id="master_date" /></div>
                    <div><label>Time</label><input type="text" id="master_time" list="time_options" /></div>
                    <div><label>Course</label><select id="master_course">
                            <option value="B.Tech">B.Tech</option>
                            <option value="M.Tech">M.Tech</option>
                        </select></div>
                    <div><label>Batch</label><input type="text" id="master_batch" list="batch_options" /></div>
                    <div><label>Semester</label><select id="master_semester">
                            <option value="1st Sem">1st Sem</option>
                            <option value="3rd Sem">3rd Sem</option>
                            <option value="5th Sem">5th Sem</option>
                            <option value="7th Sem">7th Sem</option>
                        </select></div>
                </div>
                <button class="btn btn-primary" onclick="generateMasterChart()">Generate Master Chart</button>
                <button class="btn btn-dark" onclick="downloadMasterPDF()">Download Master Chart PDF</button>
            </div>

            <div id="master-chart-preview" class="master-container" style="display: none; font-family: 'Times New Roman', serif; background: white; padding: 40px; color: black;">

                <div style="text-align: center; margin-bottom: 20px;">
                    <h2 style="margin: 0; font-weight: bold; font-size: 24px;">BIT, SINDRI</h2>
                    <h3 id="master-exam-title" style="margin: 5px 0; font-weight: bold; font-size: 16px;">[Exam Name Placeholder]
                    </h3>
                    <p style="margin: 5px 0; font-weight: bold;">Timing: <span id="master-exam-timing"></span></p>
                </div>

                <table style="width: 100%; border-collapse: collapse; font-size: 14px; border: 1px solid black;">
                    <thead>
                        <tr style="background: #f2f2f2;">
                            <th style="border: 1px solid black; padding: 5px; width: 30%;">Hall No.</th>
                            <th style="border: 1px solid black; padding: 5px; width: 10%;">Branch's</th>
                            <th style="border: 1px solid black; padding: 5px; width: 10%;">Total Student</th>
                            <th class="date-header" style="border: 1px solid black; padding: 5px; width: 8%;">...</th>
                            <th class="date-header" style="border: 1px solid black; padding: 5px; width: 8%;">...</th>
                            <th class="date-header" style="border: 1px solid black; padding: 5px; width: 8%;">...</th>
                            <th class="date-header" style="border: 1px solid black; padding: 5px; width: 8%;">...</th>
                            <th class="date-header" style="border: 1px solid black; padding: 5px; width: 8%;">...</th>
                            <th class="date-header" style="border: 1px solid black; padding: 5px; width: 8%;">...</th>
                        </tr>
                    </thead>
                    <tbody id="master-table-body">
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="2" style="border: 1px solid black; padding: 8px; font-weight: bold;">Total Present
                            </td>
                            <td id="master-grand-total" style="border: 1px solid black; padding: 8px; font-weight: bold;">0</td>
                            <td colspan="6" style="border: 1px solid black;"></td>
                        </tr>
                        <tr>
                            <td colspan="2" style="border: 1px solid black; padding: 8px; font-weight: bold;">Total Absent
                            </td>
                            <td style="border: 1px solid black;"></td>
                            <td colspan="6" style="border: 1px solid black;"></td>
                        </tr>
                        <tr>
                            <td colspan="2" style="border: 1px solid black; padding: 8px; font-weight: bold;">Unfair Means
                            </td>
                            <td style="border: 1px solid black;"></td>
                            <td colspan="6" style="border: 1px solid black;"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <div id="ai-section" class="content-section">
            <h2>AI Model Management</h2>
            <div class="card">
                <button onclick="trainAI()" class="btn btn-warning">Retrain AI Model Now</button>
                <div id="ai-status" style="margin-top:10px;"></div>
            </div>
        </div>

        <div id="teacher-section" class="content-section">
            <h2>Manage Teachers & Invigilators</h2>
            <div class="card mb-4">
                <h4 class="text-primary mb-3">Add New Teacher</h4>
                <form onsubmit="addTeacher(event)">
                    <div class="form-grid">
                        <div><label>Full Name</label><input type="text" id="teach_name" required /></div>
                        <div><label>Employee ID</label><input type="text" id="teach_id" required /></div>
                    </div>
                    <div class="form-grid">
                        <div><label>Branch</label><input type="text" id="teach_branch" required /></div>
                        <div><label>Email</label><input type="email" id="teach_email" /></div>
                    </div>
                    <button type="submit" class="btn btn-primary">Add Teacher</button>
                </form>
            </div>
            <div class="card mb-4">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h4 class="text-secondary" style="margin:0;">üë®‚Äçüè´ Teacher Directory</h4>
                    <button onclick="loadTeachers()" class="btn btn-sm btn-outline-dark"><i class="fas fa-sync"></i>
                        Refresh</button>
                </div>
                <table class="duty-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Employee ID</th>
                            <th>Department</th>
                            <th>Email</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="teacher-list-body">
                    </tbody>
                </table>
            </div>
            <div class="card border-start border-4 border-warning mb-4">
                <h4 class="text-warning mb-3">Assign Invigilation Duty</h4>
                <form onsubmit="assignDuty(event)">
                    <div class="form-grid">
                        <div><label>Select Room</label><select id="duty_room_id" onchange="fetchExamsForDuty()" required>
                                <option>-- Select Room --</option>
                            </select></div>
                        <div><label>Select Exam</label><select id="duty_exam_id" required>
                                <option>-- Select Room First --</option>
                            </select></div>
                    </div>
                    <div class="form-grid">
                        <div style="grid-column: span 2"><label>Select Teacher</label><select id="duty_teacher_id" required>
                                <option>-- Loading Teachers... --</option>
                            </select></div>
                    </div>
                    <button type="submit" class="btn btn-warning text-white fw-bold">Assign Duty</button>
                </form>
            </div>
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h4>Duty Roster</h4>
                    <button onclick="loadDuties()" class="btn btn-sm btn-outline-dark">Refresh</button>
                </div>
                <table class="duty-table">
                    <thead>
                        <tr>
                            <th>Teacher</th>
                            <th>ID</th>
                            <th>Exam</th>
                            <th>Date</th>
                            <th>Room</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="duties-table-body"></tbody>
                </table>
            </div>
        </div>

        <div id="settings-section" class="content-section">
            <h2>Settings & Maintenance</h2>
            <div class="card border-start border-4 border-danger">
                <h3 class="text-danger"><i class="fas fa-exclamation-triangle"></i> End of Semester Wipe</h3>
                <p style="color: #666;">Clear old examination data. Students & Teachers remain safe.</p>
                <button onclick="resetSystem()" class="btn btn-danger"><i class="fas fa-trash-alt"></i> WIPE EXAM DATA
                    (Safe Reset)</button>
            </div>
            <div class="card border-start border-4 border-dark mt-4" style="background-color: #fef2f2">
                <h3 class="text-dark"><i class="fas fa-skull-crossbones"></i> Factory Reset (Danger Zone)</h3>
                <p style="color: #991b1b;">WARNING: This will permanently delete ALL data.</p>
                <button onclick="resetDatabase()" class="btn btn-dark"><i class="fas fa-bomb"></i> FACTORY
                    RESET</button>
            </div>
        </div>
    </div>

    <script>
        // --- GLOBAL VARIABLES ---
        let layoutState = [];
        let allStudents = [];
        let allRoomsCache = [];
        let selectedBranchOrder = [];
        let branchDisplayMap = {};
        const branchAliases = {
            "META": "METAL",
            "METALL": "METAL",
            "METALLURGICAL": "METAL",
            "CIVIL": "CIVIL",
            "CIVIL ENGG": "CIVIL",
            "EEE": "EE",
            "ELECTRICAL": "EE",
            "MINING": "MIN",
            "CHEM": "CHE"
        };

        // --- 1. CORE & TAB SWITCHER ---
        window.showSection = function(id) {
            document.querySelectorAll('.content-section').forEach(s => s.style.display = 'none');
            const target = document.getElementById(id);
            if (target) target.style.display = 'block';
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

            if (id === 'notice-section') {
                fetchExamsForNotice();
            }
        };

        // --- 2. ROOM MANAGEMENT ---
        async function loadRooms() {
            try {
                const res = await fetch("/api/admin/get-all-rooms");
                const rooms = await res.json();
                allRoomsCache = rooms;
                document.getElementById("total-rooms-display").innerText = rooms.length;
                document.getElementById("total-capacity-display").innerText = rooms.reduce((sum, room) => sum + (parseInt(room.capacity) || 0), 0);

                const listBody = document.getElementById("room-list-body");
                if (listBody) {
                    listBody.innerHTML = rooms.map(room => `
                        <tr>
                            <td>${room.building}</td>
                            <td><strong>${room.name}</strong></td>
                            <td><span class="badge" style="background:#10b981; color:white;">${room.capacity}</span></td>
                            <td><button onclick="deleteRoom(${room.id})" class="btn btn-sm btn-danger"><i class="fas fa-trash-alt"></i></button></td>
                        </tr>`).join('');
                }

                // Populate Dropdowns
                const dropdowns = ["target_room_id", "chart_room_id", "notice_room_id", "att_room_id", "duty_room_id", "edit_room_id"];
                dropdowns.forEach((id) => {
                    const select = document.getElementById(id);
                    if (!select) return;
                    select.innerHTML = `<option value="">-- Select --</option>`;
                    if (id === "target_room_id") select.innerHTML += `<option value="all">‚ö° Auto-Allocate (All Rooms)</option>`;
                    if (id === "chart_room_id") select.innerHTML += `<option value="0">‚ö° All Rooms (Campus View)</option>`;
                    if (id === "att_room_id") select.innerHTML += `<option value="all">üñ®Ô∏è All Rooms (Batch Print)</option>`;
                    if (id === "notice_room_id") select.innerHTML += `<option value="">‚ö° All Rooms (Campus Notice)</option>`;

                    rooms.forEach((room) => {
                        const option = document.createElement("option");
                        option.value = room.id;
                        option.text = `${room.building} - ${room.name} (Cap: ${room.capacity})`;
                        option.setAttribute("data-capacity", room.capacity);
                        select.appendChild(option);
                    });
                });
            } catch (err) {
                console.error(err);
            }
        }

        async function updateRoom(e) {
            e.preventDefault();
            const data = {
                room_id: document.getElementById("edit_room_id").value,
                rows: document.getElementById("edit_rows").value,
                cols: document.getElementById("edit_cols").value,
            };
            const res = await fetch("/api/admin/update-room", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(data)
            });
            const result = await res.json();
            const notificationBox = document.getElementById("edit-notification");
            notificationBox.innerHTML = result.status === "success" ? `<div class="alert alert-success">‚úÖ ${result.message}</div>` : `<div class="alert alert-danger">‚ùå ${result.error}</div>`;
            if (result.status === "success") setTimeout(() => location.reload(), 1500);
        }

        // --- 3. STUDENT MANAGEMENT ---
        async function loadStudents() {
            try {
                const res = await fetch("/api/admin/get-all-students");
                allStudents = await res.json();
                populateBranchCheckboxes();
                const sessions = [...new Set(allStudents.map(s => s.session || "Unknown"))].sort();
                const sessionSelect = document.getElementById("filter_session");
                sessionSelect.innerHTML = '<option value="">-- All Sessions --</option>';
                sessions.forEach(sess => {
                    sessionSelect.innerHTML += `<option value="${sess}">${sess}</option>`;
                });
                filterStudents();
            } catch (err) {
                console.error(err);
            }
        }

        function filterStudents() {
            const term = document.getElementById("student_search").value.toLowerCase();
            const session = document.getElementById("filter_session").value;
            const showMissingRegOnly = document.getElementById("filter_missing_reg").checked;

            const filtered = allStudents.filter(s => {
                const name = (s.name || "").toLowerCase();
                const roll = (s.roll_no || "").toLowerCase();
                const reg = (s.reg_no || s.registration_number || "").toLowerCase();
                const isTemp = !reg || reg === "null" || reg === "" || reg === roll;

                const matchTerm = name.includes(term) || roll.includes(term) || reg.includes(term) || (term === "temp" && isTemp);
                const matchSess = session === "" || s.session === session;
                const matchRegStatus = showMissingRegOnly ? isTemp : true;
                return matchTerm && matchSess && matchRegStatus;
            });
            renderStudentTable(filtered);
        }

        function renderStudentTable(data) {
            const tbody = document.getElementById("student-table-body");
            tbody.innerHTML = "";
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted p-4">No students found.</td></tr>';
                return;
            }
            data.forEach(s => {
                const regVal = s.reg_no || s.registration_number;
                const isTemp = !regVal || regVal === 'null' || regVal.trim() === '' || regVal === s.roll_no;
                let regDisplay = isTemp ? `<span class="badge" style="background:#fff3cd; color:#856404; border:1px solid #ffeeba;">Temp (${s.roll_no})</span>` : `<span style="font-weight:600; color:#333;">${regVal}</span>`;
                const tr = document.createElement("tr");
                tr.innerHTML = `<td>${s.name}</td><td>${regDisplay}</td><td>${s.roll_no}</td><td><span class="badge" style="background:#f3f4f6; color:#1f2937; border: 1px solid #ccc;">${s.course || 'B.Tech'}</span></td><td><span class="badge" style="background:#e0e7ff; color:#3730a3;">${s.branch}</span></td><td>${s.session}</td><td><div style="display:flex; gap:8px;"><button class="btn btn-sm btn-warning" onclick="editStudent('${s.id}')"><i class="fas fa-edit"></i></button><button class="btn btn-sm btn-danger" onclick="deleteStudent('${s.id}')"><i class="fas fa-trash-alt"></i></button></div></td>`;
                tbody.appendChild(tr);
            });
        }

        function toggleStudentForm(reset = true) {
            const container = document.getElementById("student-form-container");
            const isHidden = container.style.display === "none";
            container.style.display = isHidden ? "block" : "none";
            if (reset && isHidden) {
                document.getElementById("form-title").innerText = "Add Student";
                document.getElementById("stud_id").value = "";
                document.getElementById("stud_name").value = "";
                document.getElementById("stud_reg").value = "";
                document.getElementById("stud_roll").value = "";
                document.getElementById("stud_branch").value = "";
                document.getElementById("stud_session").value = "";
                document.getElementById("stud_course").value = "B.Tech";
                document.getElementById("save-btn").innerText = "Save Student";
            }
        }

        window.editStudent = function(id) {
            const student = allStudents.find(s => s.id == id);
            if (!student) return;
            toggleStudentForm(false);
            document.getElementById("student-form-container").style.display = "block";
            document.getElementById("form-title").innerText = "Edit Student";
            document.getElementById("stud_id").value = student.id;
            document.getElementById("stud_name").value = student.name;
            document.getElementById("stud_reg").value = (student.reg_no && student.reg_no !== 'null') ? student.reg_no : "";
            document.getElementById("stud_roll").value = student.roll_no;
            document.getElementById("stud_branch").value = student.branch;
            document.getElementById("stud_session").value = student.session;
            document.getElementById("stud_course").value = student.course || "B.Tech";
            document.getElementById("save-btn").innerText = "Update Student";
            document.getElementById("student-form-container").scrollIntoView({
                behavior: "smooth"
            });
        };

        window.deleteStudent = async function(id) {
            if (!confirm("‚ö†Ô∏è Are you sure you want to permanently delete this student?")) return;
            try {
                const res = await fetch("/api/admin/delete-student", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        id: id
                    })
                });
                const result = await res.json();
                if (res.ok) {
                    allStudents = allStudents.filter(s => s.id != id);
                    filterStudents();
                } else {
                    alert("Failed to delete: " + (result.message || "Unknown error"));
                }
            } catch (err) {
                alert("Server Error");
            }
        };

        async function handleStudentSave(e) {
            e.preventDefault();
            const id = document.getElementById("stud_id").value;
            let regNo = document.getElementById("stud_reg").value;
            const rollNo = document.getElementById("stud_roll").value;
            if (!regNo || regNo.trim() === "") {
                regNo = rollNo;
            }
            const data = {
                name: document.getElementById("stud_name").value,
                registration_number: regNo,
                roll_no: rollNo,
                branch: document.getElementById("stud_branch").value,
                session: document.getElementById("stud_session").value,
                course: document.getElementById("stud_course").value
            };
            const url = id ? "/api/admin/update-student" : "/api/admin/add-student";
            if (id) data.id = id;
            try {
                const res = await fetch(url, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.status === "success" || res.ok) {
                    toggleStudentForm();
                    loadStudents();
                    alert(id ? "Student Updated!" : "Student Added!");
                } else {
                    alert("Error: " + (result.message || "Failed"));
                }
            } catch (err) {
                alert("Server Error");
            }
        }

        function populateBranchCheckboxes() {
            const container = document.getElementById("branch-checkbox-container");
            if (!container) return;
            const rawBranches = [...new Set(allStudents.map(s => s.branch ? s.branch.trim().toUpperCase() : "UNKNOWN"))].sort();
            container.innerHTML = "";
            branchDisplayMap = {};
            rawBranches.forEach(raw => {
                const displayName = branchAliases[raw] || raw;
                if (!branchDisplayMap[displayName]) branchDisplayMap[displayName] = [];
                branchDisplayMap[displayName].push(raw);
            });
            Object.keys(branchDisplayMap).sort().forEach(displayName => {
                const wrapper = document.createElement("div");
                wrapper.style.cssText = "display:flex; align-items:center; gap:5px; background:#f3f4f6; padding:4px 8px; border-radius:15px; border:1px solid #ddd; cursor:pointer;";
                wrapper.innerHTML = `<input type="checkbox" value="${displayName}" onchange="handleBranchToggle('${displayName}', this.checked)" id="chk_${displayName.replace(/\W/g, '')}"> <label for="chk_${displayName.replace(/\W/g, '')}">${displayName}</label>`;
                container.appendChild(wrapper);
            });
        }

        function handleBranchToggle(displayName, isChecked) {
            if (isChecked) {
                if (!selectedBranchOrder.includes(displayName)) selectedBranchOrder.push(displayName);
            } else {
                selectedBranchOrder = selectedBranchOrder.filter(b => b !== displayName);
            }
            const expandedValues = [];
            selectedBranchOrder.forEach(name => {
                if (branchDisplayMap[name]) expandedValues.push(...branchDisplayMap[name]);
            });
            document.getElementById("branches_input").value = expandedValues.join(", ");
            document.getElementById("priority-display").innerHTML = selectedBranchOrder.join(" <i class='fas fa-arrow-right'></i> ") || "None";
            updateStats();
        }

        function selectAllBranches() {
            document.querySelectorAll("#branch-checkbox-container input").forEach(cb => {
                cb.checked = true;
                handleBranchToggle(cb.value, true);
            });
        }

        function clearBranches() {
            document.querySelectorAll("#branch-checkbox-container input").forEach(cb => {
                cb.checked = false;
                handleBranchToggle(cb.value, false);
            });
        }

        // --- 4. SEATING & CHART ---
        async function updateStats() {
            const session = document.getElementById("target_session").value;
            const branches = document.getElementById("branches_input").value;
            const course = document.getElementById("gen_course").value;
            if (!session) return;
            try {
                const res = await fetch("/api/admin/student-stats", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        session,
                        branches,
                        course
                    })
                });
                const data = await res.json();
                document.getElementById("stat_selected").innerText = data.matching_students;
                document.getElementById("stat_breakdown").innerHTML = Object.entries(data.branch_breakdown).map(([b, c]) => `<span class="badge" style="background:white; border:1px solid #ccc">${b}: ${c}</span>`).join(" ");
            } catch (err) {
                console.error(err);
            }
        }

        async function generateSeating(e) {
            e.preventDefault();
            const btn = document.querySelector('#seatingForm button[type="submit"]');
            btn.disabled = true;
            btn.innerText = "Processing...";
            let roomBranchMap = {};
            if (document.getElementById('target_room_id').value === 'all') {
                document.querySelectorAll('.room-branch-input').forEach(input => {
                    if (input.value.trim()) roomBranchMap[input.getAttribute('data-room-id')] = input.value.trim();
                });
            }
            const data = {
                room_id: document.getElementById('target_room_id').value,
                exam_name: document.getElementById('exam_name').value,
                branches: document.getElementById('branches_input').value,
                date: document.getElementById('exam_date').value,
                time: document.getElementById('exam_time').value,
                target_session: document.getElementById('target_session').value,
                semester: document.getElementById('gen_semester').value,
                course: document.getElementById('gen_course').value,
                max_branches: document.getElementById('max_branches_limit').value,
                room_branch_map: roomBranchMap
            };
            try {
                const res = await fetch('/api/admin/generate-seating', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                const box = document.getElementById('seating-result');
                box.innerHTML = result.success ? `‚úÖ ${result.message}` : `‚ùå ${result.error}`;
                box.style.color = result.success ? 'green' : 'red';
            } catch (err) {
                alert("Server Error");
            } finally {
                btn.disabled = false;
                btn.innerText = "Run Seating Algorithm";
            }
        }

        function toggleBranchMapping() {
            const val = document.getElementById('target_room_id').value;
            const container = document.getElementById('room-branch-mapping-container');
            const list = document.getElementById('room-mapping-list');
            if (val === 'all') {
                container.style.display = 'block';
                list.innerHTML = '';
                allRoomsCache.forEach(room => {
                    list.innerHTML += `<div style="display:flex; gap:10px; margin-bottom:5px; align-items:center;"><div style="flex:1; font-weight:bold; font-size:0.9rem;">${room.building} - ${room.name}</div><input type="text" class="room-branch-input" data-room-id="${room.id}" placeholder="e.g. CSE, IT" style="flex:2; padding:5px;"></div>`;
                });
            } else {
                container.style.display = 'none';
            }
            updateStats();
        }

        // --- EXAM FETCHER FOR NOTICE ---
        async function fetchExamsForNotice() {
            const roomId = document.getElementById("notice_room_id").value || "0";
            const sel = document.getElementById("notice_exam_id");

            sel.innerHTML = '<option>Loading Exams...</option>';
            sel.disabled = true;

            try {
                const url = `/api/admin/get-exams-in-room/${roomId}`;
                const res = await fetch(url);
                const exams = await res.json();

                sel.innerHTML = '<option value="">-- Select Exam Event --</option>';
                if (exams.length === 0) {
                    sel.innerHTML = '<option disabled>No exams found</option>';
                } else {
                    exams.forEach(e => {
                        const opt = document.createElement("option");
                        opt.value = e.id;
                        opt.text = `${e.name} (${e.date})`;
                        sel.appendChild(opt);
                    });
                }
                sel.disabled = false;
            } catch (e) {
                console.error(e);
                sel.innerHTML = '<option>Error loading exams</option>';
            }
        }


        // --- NOTICE GENERATION LOGIC (SEQUENTIAL) ---
        async function generateNotice() {
            const course = document.getElementById('notice_course').value;
            const batch = document.getElementById('notice_batch').value;
            const semester = document.getElementById('notice_semester').value;
            const dateVal = document.getElementById('notice_date').value;
            const timeVal = document.getElementById('notice_time').value;
            const roomId = document.getElementById('notice_room_id').value || "0";
            const examId = document.getElementById("notice_exam_id").value;

            if (!batch || !dateVal || !timeVal) {
                alert("Please fill in Batch, Date, and Time for the header.");
                return;
            }

            if (!examId) {
                alert("‚ö†Ô∏è Please select an 'Exam Event' from the dropdown so we know which student data to load.");
                return;
            }

            // Header construction
            const dateObj = new Date(dateVal);
            const formattedDate = `${String(dateObj.getDate()).padStart(2, '0')}-${String(dateObj.getMonth() + 1).padStart(2, '0')}-${dateObj.getFullYear()}`;
            const semNum = semester.split(" ")[0].toUpperCase();
            const examTitle = `${semNum} [${course}] END SEM ${dateObj.getFullYear()} - ${semester.toUpperCase()} (${formattedDate}) - BATCH ${batch}`;

            document.getElementById('notice-title-display').innerText = examTitle;
            document.getElementById('notice-timing-display').innerText = timeVal.toUpperCase();

            const loadingBtn = document.querySelector('button[onclick="generateNotice()"]');
            loadingBtn.innerText = "Generating...";

            try {
                const url = `/api/admin/get-seating-chart/${roomId}?course=${course}&exam_id=${examId}`;
                const res = await fetch(url);
                const data = await res.json();

                const tbody = document.getElementById('notice-body');
                tbody.innerHTML = "";

                let roomsData = [];
                if (data.rooms) roomsData = data.rooms;
                else if (data.seats) roomsData = [data];

                if (roomsData.length === 0) {
                    tbody.innerHTML = "<tr><td colspan='4' class='text-center'>No data found for this exam. Check the 'Visual Chart' to verify allocation exists.</td></tr>";
                    document.getElementById('notice-container').style.display = 'block';
                    loadingBtn.innerText = "Generate Notice Preview";
                    return;
                }

                roomsData.sort((a, b) => a.room_name.localeCompare(b.room_name));

                let grandTotal = 0;

                roomsData.forEach(room => {
                    if (!room.seats || room.seats.length === 0) return;

                    // Group by Branch
                    const branchMap = {};
                    room.seats.forEach(seat => {
                        const b = seat.branch || "Unknown";
                        if (!branchMap[b]) branchMap[b] = [];
                        branchMap[b].push(seat);
                    });

                    // Convert map to array for sorting
                    const branchGroups = Object.keys(branchMap).map(branch => {
                        const students = branchMap[branch];
                        // Sort by RegNo/Roll to find strict range
                        students.sort((a, b) => {
                            const valA = a.reg_no || a.roll_no || "";
                            const valB = b.reg_no || b.roll_no || "";
                            return valA.localeCompare(valB, undefined, {
                                numeric: true,
                                sensitivity: 'base'
                            });
                        });

                        return {
                            branch: branch,
                            start: students[0].reg_no || students[0].roll_no,
                            end: students[students.length - 1].reg_no || students[students.length - 1].roll_no,
                            count: students.length,
                            // Key for sorting the rows: Start Reg No
                            sortKey: students[0].reg_no || students[0].roll_no || ""
                        };
                    });

                    // SORT: Sequential by Starting Reg No (User Request)
                    branchGroups.sort((a, b) => a.sortKey.localeCompare(b.sortKey, undefined, {
                        numeric: true,
                        sensitivity: 'base'
                    }));

                    let roomTotal = 0;
                    branchGroups.forEach(g => roomTotal += g.count);
                    grandTotal += roomTotal;

                    // Render Rows
                    branchGroups.forEach((row, index) => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td>${row.branch}</td><td>${row.start} To ${row.end}</td><td>$= ${row.count}$</td>`;

                        // Merge Hall No cell (Rowspan)
                        if (index === 0) {
                            tr.innerHTML += `<td rowspan="${branchGroups.length}" class="text-center font-bold" style="vertical-align: middle;">${room.room_name}</td>`;
                        }
                        tbody.appendChild(tr);
                    });

                    // Room Total Row
                    const totalTr = document.createElement('tr');
                    totalTr.innerHTML = `
                        <td colspan="2" class="text-right font-bold no-border-right">Room Total</td>
                        <td class="font-bold no-border-left">$= ${roomTotal}$</td>
                        <td></td>
                    `;
                    tbody.appendChild(totalTr);
                });

                document.getElementById('notice-grand-total').innerText = grandTotal;
                document.getElementById('notice-container').style.display = 'block';
                document.getElementById('notice-container').scrollIntoView({
                    behavior: 'smooth'
                });

            } catch (err) {
                console.error(err);
                alert("Error generating notice.");
            } finally {
                loadingBtn.innerText = "Generate Notice Preview";
            }
        }

        function downloadNoticePDF() {
            const element = document.getElementById('notice-container');
            if (element.style.display === 'none') {
                alert("Please Generate the Notice Preview first!");
                return;
            }

            const examDate = document.getElementById("notice_date").value || "Exam";
            const opt = {
                margin: 10,
                filename: `Seating_Notice_${examDate}.pdf`,
                image: {
                    type: 'jpeg',
                    quality: 0.98
                },
                html2canvas: {
                    scale: 2
                },
                jsPDF: {
                    unit: 'mm',
                    format: 'a4',
                    orientation: 'portrait'
                }
            };

            html2pdf().set(opt).from(element).save();
        }

        // --- EXAM FETCHER FOR CHART ---
        async function fetchExamsForRoom() {
            const roomId = document.getElementById("chart_room_id").value;
            const sel = document.getElementById("chart_exam_id");
            sel.innerHTML = '<option>Loading...</option>';
            sel.disabled = true;
            try {
                const url = `/api/admin/get-exams-in-room/${roomId}`;
                const res = await fetch(url);
                const exams = await res.json();
                sel.innerHTML = '<option value="">-- Select Session --</option>';
                if (exams.length === 0) sel.innerHTML = '<option disabled>No exams found</option>';
                exams.forEach(e => {
                    const opt = document.createElement("option");
                    opt.value = e.id;
                    opt.text = `${e.name}`;
                    sel.appendChild(opt);
                });
                sel.disabled = false;
            } catch (e) {
                sel.innerHTML = '<option>Error</option>';
            }
        }

        // --- UPDATED CHART LOADER ---
        async function loadChart() {
            const roomId = document.getElementById("chart_room_id").value;
            const examId = document.getElementById("chart_exam_id").value;
            const course = document.getElementById("chart_course").value;
            const container = document.getElementById("seating-grid");

            if (!roomId || !examId) return alert("Please select a Room and Session first.");
            container.innerHTML = "<p style='text-align:center; padding:50px; font-size:1.2rem; color:#666;'>‚è≥ Loading Seating Data...</p>";

            try {
                const url = `/api/admin/get-seating-chart/${roomId}?exam_id=${examId}&course=${course}`;
                const res = await fetch(url);
                const data = await res.json();
                container.innerHTML = "";

                const renderRoom = (rData) => {
                    const wrap = document.createElement("div");
                    wrap.className = "chart-wrapper";
                    wrap.style.marginBottom = "40px";
                    wrap.innerHTML = `<h3 style='border-bottom:2px solid #eee; padding-bottom:10px; margin-bottom:15px;'>${rData.room_name}</h3>`;

                    const grid = document.createElement("div");
                    grid.className = "visual-grid";
                    const cols = rData.cols || 6;
                    grid.style.display = "grid";
                    grid.style.gap = "10px";
                    grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
                    grid.dataset.cols = cols;

                    const seatMap = {};
                    (rData.seats || []).forEach(s => {
                        let r = parseInt(s.row),
                            c = parseInt(s.col);
                        if ((!r || !c) && s.label) {
                            const m = s.label.match(/R(\d+)-C(\d+)/i);
                            if (m) {
                                r = parseInt(m[1]);
                                c = parseInt(m[2]);
                            }
                        }
                        if (r && c) seatMap[`${r}-${c}`] = s;
                    });

                    const rows = rData.rows || 10;
                    for (let r = 1; r <= rows; r++) {
                        for (let c = 1; c <= cols; c++) {
                            const s = seatMap[`${r}-${c}`];
                            const div = document.createElement("div");
                            div.className = "seat-box";
                            div.style.border = "1px solid #ccc";
                            div.style.borderRadius = "4px";
                            div.style.padding = "5px";
                            div.style.textAlign = "center";
                            div.style.minHeight = "60px";
                            div.style.display = "flex";
                            div.style.flexDirection = "column";
                            div.style.justifyContent = "center";
                            if (s) {
                                div.style.background = "#eff6ff";
                                div.style.borderColor = "#2563eb";
                                div.innerHTML = `<strong style="color:#000; font-size:12px;">${s.reg_no || s.roll_no}</strong><span style="font-size:10px; color:#333;">${s.branch}</span><small style="color:#888; font-size:9px; margin-top:2px;">R${r}-C${c}</small>`;
                            } else {
                                div.style.background = "#fff";
                                div.innerHTML = `<small style="color:#ddd; font-size:9px;">R${r}-C${c}<br>VACANT</small>`;
                            }
                            grid.appendChild(div);
                        }
                    }
                    wrap.appendChild(grid);
                    container.appendChild(wrap);
                };

                if (data.mode === 'multi') {
                    if (!data.rooms || data.rooms.length === 0) container.innerHTML = "<div class='alert alert-warning'>No students found allocated to this session.</div>";
                    else data.rooms.forEach(renderRoom);
                } else if (data.room_name) {
                    renderRoom(data);
                } else {
                    container.innerHTML = `<div class="alert alert-danger">No data found. ${data.error || ""}</div>`;
                }
            } catch (e) {
                console.error(e);
                container.innerHTML = `<div class="alert alert-danger">Error loading chart: ${e.message}</div>`;
            }
        }

        function downloadPDF() {
            const gridElement = document.getElementById("seating-grid");
            if (!gridElement || !gridElement.innerHTML.trim() || gridElement.innerText.includes("Loading")) return alert("Please load the Real Data first!");
            const wrappers = gridElement.querySelectorAll(".chart-wrapper");
            if (wrappers.length === 0) return alert("No seating data visible to download.");

            const pdfContainer = document.createElement("div");
            pdfContainer.style.padding = "20px";
            pdfContainer.style.fontFamily = "Arial, sans-serif";
            pdfContainer.style.color = "#000";

            const examSelect = document.getElementById("chart_exam_id");
            const examText = examSelect.options[examSelect.selectedIndex].text;
            const generatedTime = new Date().toLocaleString();

            wrappers.forEach((wrapper, index) => {
                const roomName = wrapper.querySelector("h3") ? wrapper.querySelector("h3").innerText : "Exam Hall";
                const grid = wrapper.querySelector(".visual-grid");
                if (!grid) return;

                const pageDiv = document.createElement("div");
                if (index > 0) {
                    pageDiv.style.pageBreakBefore = "always";
                    pageDiv.style.marginTop = "30px";
                }
                pageDiv.style.marginBottom = "30px";

                const headerHTML = `
                    <div style="text-align: center; margin-bottom: 15px; border-bottom: 2px solid #000; padding-bottom: 10px;">
                        <h2 style="margin: 0; font-size: 16px; font-weight:bold; text-transform:uppercase;">Examination Seating Plan</h2>
                        <h3 style="margin: 5px 0; font-size: 14px; font-weight:normal;">All Rooms (Campus View)</h3>
                        <p style="margin: 5px 0; font-size: 11px; font-weight:bold;">${examText}</p>
                        <div style="display:flex; justify-content:space-between; margin-top:5px; font-size:10px; color:#555;">
                            <span>Generated: ${generatedTime}</span><span><strong>${roomName}</strong></span>
                        </div>
                    </div>`;
                pageDiv.innerHTML = headerHTML;

                const colCount = parseInt(grid.dataset.cols || 6);
                const table = document.createElement("table");
                table.style.width = "100%";
                table.style.borderCollapse = "collapse";
                table.style.fontSize = "10px";

                const seats = Array.from(grid.children);
                let tr = document.createElement("tr");

                seats.forEach((seat, i) => {
                    const td = document.createElement("td");
                    td.style.border = "1px solid #000";
                    td.style.width = `${100 / colCount}%`;
                    td.style.height = "45px";
                    td.style.padding = "4px";
                    td.style.verticalAlign = "middle";
                    td.style.textAlign = "center";

                    const regNo = seat.querySelector("strong") ? seat.querySelector("strong").innerText : "";
                    const branch = seat.querySelector("span") ? seat.querySelector("span").innerText : "";
                    const label = seat.querySelector("small") ? seat.querySelector("small").innerText : "";

                    if (regNo) {
                        td.innerHTML = `<div style="font-weight:bold; font-size:11px;">${regNo}</div><div style="font-size:9px; margin:2px 0;">${branch}</div><div style="font-size:8px; color:#666;">${label}</div>`;
                    } else {
                        td.innerHTML = `<div style="color:#ccc; font-size:8px;">${label}<br>VACANT</div>`;
                        td.style.backgroundColor = "#fafafa";
                    }
                    tr.appendChild(td);
                    if ((i + 1) % colCount === 0) {
                        table.appendChild(tr);
                        tr = document.createElement("tr");
                    }
                });
                if (tr.children.length > 0) {
                    while (tr.children.length < colCount) {
                        const td = document.createElement("td");
                        td.style.border = "1px solid #000";
                        tr.appendChild(td);
                    }
                    table.appendChild(tr);
                }
                pageDiv.appendChild(table);
                pdfContainer.appendChild(pageDiv);
            });

            const opt = {
                margin: [10, 10, 10, 10],
                filename: `Seating_Plan_${new Date().toISOString().split('T')[0]}.pdf`,
                image: {
                    type: 'jpeg',
                    quality: 0.98
                },
                html2canvas: {
                    scale: 2,
                    useCORS: true
                },
                jsPDF: {
                    unit: 'mm',
                    format: 'a4',
                    orientation: 'landscape'
                }
            };
            html2pdf().set(opt).from(pdfContainer).save();
        }

        async function uploadCSV(e) {
            e.preventDefault();
            const fd = new FormData();
            fd.append("file", document.getElementById("csv_file").files[0]);
            const res = await fetch("/api/admin/bulk-upload", {
                method: "POST",
                body: fd
            });
            const data = await res.json();
            document.getElementById("upload-status").innerHTML = `<div class="alert alert-success">${data.message}</div>`;
            loadStudents();
        }
        async function deleteBatch() {
            if (confirm("Are you sure?")) await fetch('/api/admin/delete-students-by-session', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    session: document.getElementById("delete_batch_input").value
                })
            });
            loadStudents();
        }

        function printSection(id) {
            const count = parseInt(document.getElementById("att_subject_count").value) || 1;
            const orientation = count > 3 ? "landscape" : "portrait";

            const content = document.getElementById(id).innerHTML;
            const w = window.open();
            w.document.write(`
                <html>
                    <head>
                        <title>Print</title>
                        <style>
                            @media print { 
                                @page { size: A4 ${orientation}; margin: 10mm; } 
                                .att-page-break { page-break-after: always; }
                            }
                            body { font-family: 'Times New Roman', serif; }
                            .att-sheet-container { width: 100%; }
                            /* Copying style from main doc for correct render */
                            .att-top-header { width: 100%; margin-bottom: 5px; }
                            .att-top-header td { vertical-align: top; font-weight: bold; font-size: 14px; }
                            .att-title-main { text-align: center; font-weight: bold; text-decoration: underline; font-size: 16px; margin: 5px 0; text-transform: uppercase; }
                            .att-hall-details { width: 100%; border: 1px solid #000; margin-bottom: 10px; padding: 5px; font-weight: bold; font-size: 13px; }
                            .att-hall-details td { padding: 2px 10px; }
                            .att-info-block { font-size: 14px; font-weight: bold; margin-bottom: 10px; line-height: 1.5; text-align: center; }
                            .att-real-table { width: 100%; border-collapse: collapse; font-size: 12px; }
                            .att-real-table th, .att-real-table td { border: 1px solid black; padding: 5px; text-align: center; vertical-align: middle; }
                            .att-real-table th { background-color: #f2f2f2; text-transform: uppercase; }
                            .att-bottom-footer { margin-top: 40px; display: flex; justify-content: space-between; font-weight: bold; font-size: 14px; padding-bottom: 20px; }
                        </style>
                    </head>
                    <body>${content}</body>
                </html>`);
            w.document.close();
            setTimeout(() => {
                w.print();
                w.close();
            }, 500);
        }

        // --- UPDATED: GENERATE ATTENDANCE SHEET (Corrected Header/Footer & Layout) ---
        function generateAttendance() {
            const course = document.getElementById("att_course").value;
            const batch = document.getElementById("att_batch").value;
            const semester = document.getElementById("att_semester").value;
            const date = document.getElementById("att_date").value;
            const time = document.getElementById("att_time").value;
            const subjectCount = parseInt(document.getElementById("att_subject_count").value) || 1;

            // --- NEW ROOM NAME LOGIC ---
            const roomSelect = document.getElementById("att_room_id");
            let hallName = "________________"; // Default blank line if "All Rooms" or nothing selected

            if (roomSelect.value && roomSelect.value !== "all") {
                // Get the text: "Science Block - Hall 101 (Cap: 40)"
                const fullText = roomSelect.options[roomSelect.selectedIndex].text;
                // Remove the capacity part (anything after '(' )
                hallName = fullText.split("(")[0].trim();
            }

            // Format Date
            let dateStr = "..................";
            if (date) {
                const d = new Date(date);
                dateStr = `${d.getDate()}/${d.getMonth() + 1}/${d.getFullYear()}`;
            }

            // Filter Students
            let filteredStudents = allStudents.filter(s => {
                let matchBatch = (!batch || s.session === batch);
                let matchCourse = (!course || s.course === course);
                // Note: We are filtering by Batch/Course mainly. 
                return matchBatch && matchCourse;
            });

            if (filteredStudents.length === 0) {
                document.getElementById("attendance-preview").innerHTML = "<div class='alert alert-warning'>No students found for this batch/course.</div>";
                document.getElementById("attendance-preview").style.display = "block";
                return;
            }

            // Sort by Branch, then Reg No
            filteredStudents.sort((a, b) => {
                if (a.branch !== b.branch) return a.branch.localeCompare(b.branch);
                return (a.reg_no || a.roll_no).localeCompare(b.reg_no || b.roll_no);
            });

            // Group by Branch
            const studentsByBranch = {};
            filteredStudents.forEach(s => {
                const b = s.branch || "Unknown";
                if (!studentsByBranch[b]) studentsByBranch[b] = [];
                studentsByBranch[b].push(s);
            });

            let html = "";
            const rowsPerPage = 20; // Pagination limit

            Object.keys(studentsByBranch).forEach(branch => {
                const students = studentsByBranch[branch];
                const totalPages = Math.ceil(students.length / rowsPerPage);

                for (let i = 0; i < totalPages; i++) {
                    const pageStudents = students.slice(i * rowsPerPage, (i + 1) * rowsPerPage);

                    html += `<div class="att-sheet-container att-page-break">`;

                    // HEADER TABLE (Left/Right Alignment)
                    html += `
                        <table class="att-top-header">
                            <tr>
                                <td style="text-align:left;">JHARKHAND UNIVERSITY OF TECHNOLOGY, RANCHI</td>
                                <td style="text-align:right;">BIT SINDRI, DHANBAD</td>
                            </tr>
                        </table>
                    `;

                    // CENTER TITLE
                    html += `<div class="att-title-main">ATTENDANCE SHEET</div>`;

                    // *** HALL/SEM/CENTRE/BRANCH BLOCK ***
                    html += `
                        <table class="att-hall-details">
                            <tr>
                                <td>Hall No: ${hallName}</td>
                                <td>Semester: ${semester}</td>
                            </tr>
                            <tr>
                                <td>Centre: B.I.T. Sindri</td>
                                <td>Branch: ${branch}</td>
                            </tr>
                        </table>
                    `;

                    // INFO BLOCK
                    const examYear = batch ? batch.split("-")[1] : new Date().getFullYear();
                    html += `
                        <div class="att-info-block">
                            <div>Name of Examination: ${course} ${semester} Examination ${examYear}</div>
                            <div style="display:flex; justify-content:space-between; margin-top:5px; padding:0 20px;">
                                <span>Subject: ...........................................</span>
                                <span>Date of Exam: ${dateStr}</span>
                                <span>Sitting: ${time ? time.split('(')[0] : '...........'}</span>
                            </div>
                        </div>
                    `;

                    // DYNAMIC TABLE GENERATION
                    html += `<table class="att-real-table"><thead><tr>`;

                    // Fixed Columns
                    html += `<th style="width:5%">Sl.<br>No.</th>`;
                    html += `<th style="width:15%">Regist.<br>No.</th>`;
                    html += `<th style="width:25%">Name of Student</th>`;

                    // Dynamic Columns based on Selection (1 vs 6)
                    if (subjectCount === 1) {
                        // STRICT PDF FORMAT
                        html += `<th style="width:15%">Answer<br>Book No.</th>`;
                        html += `<th style="width:20%">Signature of Student</th>`;
                        html += `<th style="width:15%">Remarks</th>`;
                    } else {
                        // MULTI-EXAM FORMAT
                        for (let j = 0; j < subjectCount; j++) {
                            html += `<th>Paper ${j + 1}<br><br><span style="font-weight:normal; font-size:10px;">Book No / Signature</span></th>`;
                        }
                        html += `<th>Remarks</th>`;
                    }

                    html += `</tr></thead><tbody>`;

                    pageStudents.forEach((s, idx) => {
                        const serial = (i * rowsPerPage) + idx + 1;
                        html += `<tr>`;
                        html += `<td>${serial}</td>`;
                        html += `<td>${s.reg_no || s.roll_no}</td>`;
                        html += `<td style="text-align:left; padding-left:10px;">${s.name}</td>`;

                        if (subjectCount === 1) {
                            // Empty Answer Book & Sig Box
                            html += `<td></td><td></td><td></td>`;
                        } else {
                            // Multiple Empty Boxes
                            for (let j = 0; j < subjectCount; j++) {
                                html += `<td></td>`;
                            }
                            html += `<td></td>`;
                        }
                        html += `</tr>`;
                    });

                    html += `</tbody></table>`;

                    // FOOTER
                    html += `
                        <div class="att-bottom-footer">
                            <div>Name & Signature of Invigilator ...........................................</div>
                            <div>Center Superintendent ...........................................</div>
                        </div>
                    `;

                    html += `</div>`; // End Page Container
                }
            });

            const preview = document.getElementById("attendance-preview");
            preview.innerHTML = html;
            preview.style.display = "block";
            preview.scrollIntoView({
                behavior: "smooth"
            });
        }

        // --- UPDATED: GENERATE DISTRIBUTION TABLE (Matches PDF) ---
        async function generateDistribution() {
            // 1. Get Inputs
            const course = document.getElementById("dist_course").value;
            const batch = document.getElementById("dist_batch").value;
            const date = document.getElementById("dist_date").value;
            const time = document.getElementById("dist_time").value;

            if (!date || !time || !batch) {
                alert("Please select Date, Time, and Batch.");
                return;
            }

            // 2. Set Header Info (Matches PDF)
            const year = new Date(date).getFullYear();
            const titleText = `[${course}] End sem ${year} - ${batch} Batch`;
            document.getElementById("dist-print-title").innerText = titleText;
            document.getElementById("dist-print-timing").innerText = `Timing: ${time}`;

            // 3. Fetch Data
            try {
                const btn = document.querySelector('button[onclick="generateDistribution()"]');
                const originalText = btn.innerText;
                btn.innerText = "Processing...";

                // Assuming backend endpoint exists or use a generic fetch if not
                const res = await fetch('/api/admin/get-distribution-stats', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        date,
                        time,
                        batch,
                        course
                    })
                });

                if (!res.ok) throw new Error("Failed to fetch distribution data");

                const data = await res.json();
                // Expected Data Format: Array of objects { branch: "CSE", room: "LH-101", count: 15 }

                renderDistributionTable(data);

                // Show Preview
                document.getElementById("distribution-preview").style.display = "block";
                document.getElementById("distribution-preview").scrollIntoView({
                    behavior: "smooth"
                });
                btn.innerText = originalText;

            } catch (err) {
                console.error(err);
                alert("Error generating distribution. Ensure backend API '/api/admin/get-distribution-stats' is active.");
                const btn = document.querySelector('button[onclick="generateDistribution()"]');
                btn.innerText = "Generate";
            }
        }

        function renderDistributionTable(data) {
            const tbody = document.getElementById("dist-body");
            tbody.innerHTML = "";

            // 1. Group Data by Branch -> Room
            const branchMap = {};

            data.forEach(item => {
                const b = item.branch || "Unknown";
                const r = item.room || "Unassigned";
                const c = parseInt(item.count || 1);

                if (!branchMap[b]) branchMap[b] = {
                    rooms: {},
                    total: 0
                };

                if (!branchMap[b].rooms[r]) branchMap[b].rooms[r] = 0;
                branchMap[b].rooms[r] += c;
                branchMap[b].total += c;
            });

            // 2. Sort Branches Alphabetically
            const sortedBranches = Object.keys(branchMap).sort();

            // 3. Build Table Rows
            sortedBranches.forEach((branch, index) => {
                const branchData = branchMap[branch];

                // Format the Room String: "LH-101=30, LH-201=25"
                const roomStrings = Object.keys(branchData.rooms).sort().map(roomName => {
                    return `<span style="white-space:nowrap; margin-right: 10px;"><b>${roomName}</b>=${branchData.rooms[roomName]}</span>`;
                });

                // Join with commas or just spaces
                const roomDisplayHTML = roomStrings.join(", ");

                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td style="border: 1px solid black; padding: 8px; text-align: center;">${index + 1}</td>
                    <td style="border: 1px solid black; padding: 8px; font-weight: bold;">${branch}</td>
                    <td style="border: 1px solid black; padding: 8px;">
                        <div style="line-height: 1.6;">
                            ${roomDisplayHTML}
                        </div>
                        <div style="margin-top: 8px; font-weight: bold; border-top: 1px dashed #ccc; padding-top: 4px;">
                            Total: ${branchData.total}
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            if (sortedBranches.length === 0) {
                tbody.innerHTML = "<tr><td colspan='3' class='text-center p-3'>No data found for this selection.</td></tr>";
            }
        }

        // --- NEW: GENERATE MASTER CHART (Matches PDF) ---
        async function generateMasterChart() {
            const dateVal = document.getElementById("master_date").value;
            const timeVal = document.getElementById("master_time").value;
            const course = document.getElementById("master_course").value;
            const batch = document.getElementById("master_batch").value;
            const semester = document.getElementById("master_semester").value;

            if (!dateVal || !timeVal) {
                alert("Please select Date and Time.");
                return;
            }

            try {
                // Fetch data from existing endpoint
                const url = `/api/admin/master-chart?date=${dateVal}&time=${encodeURIComponent(timeVal)}&course=${course}&batch=${batch}&semester=${semester}`;
                const res = await fetch(url);
                const result = await res.json();

                if (result.error) {
                    alert(result.error);
                    return;
                }

                // Populate Header
                document.getElementById("master-exam-title").innerText = result.exam_title;
                document.getElementById("master-exam-timing").innerText = result.timing;

                // Populate Table
                const tbody = document.getElementById("master-table-body");
                tbody.innerHTML = "";

                // Populate Date Headers
                const headers = document.querySelectorAll('.date-header');
                result.date_headers.forEach((dateStr, idx) => {
                    if (headers[idx]) headers[idx].innerText = dateStr;
                });

                // Render Rows (Grouped by Hall)
                result.data.forEach(room => {
                    const rowCount = room.branches.length;

                    room.branches.forEach((branchObj, index) => {
                        const tr = document.createElement("tr");

                        // 1. Hall No (Rowspan for first row of the room)
                        if (index === 0) {
                            const tdHall = document.createElement("td");
                            tdHall.innerText = room.hall_no;
                            tdHall.rowSpan = rowCount;
                            tdHall.style.border = "1px solid black";
                            tdHall.style.padding = "5px";
                            tdHall.style.verticalAlign = "middle";
                            tdHall.style.fontWeight = "bold";
                            tr.appendChild(tdHall);
                        }

                        // 2. Branch Name
                        const tdBranch = document.createElement("td");
                        tdBranch.innerText = branchObj.name;
                        tdBranch.style.border = "1px solid black";
                        tdBranch.style.padding = "5px";
                        tr.appendChild(tdBranch);

                        // 3. Total Count
                        const tdCount = document.createElement("td");
                        tdCount.innerText = branchObj.count;
                        tdCount.style.border = "1px solid black";
                        tdCount.style.padding = "5px";
                        tdCount.style.textAlign = "center";
                        tr.appendChild(tdCount);

                        // 4. Empty Date Columns (6)
                        for (let i = 0; i < 6; i++) {
                            const tdEmpty = document.createElement("td");
                            tdEmpty.style.border = "1px solid black";
                            tr.appendChild(tdEmpty);
                        }

                        tbody.appendChild(tr);
                    });
                });

                document.getElementById("master-grand-total").innerText = result.grand_total;

                // Show Preview
                document.getElementById("master-chart-preview").style.display = "block";
                document.getElementById("master-chart-preview").scrollIntoView({
                    behavior: "smooth"
                });

            } catch (err) {
                console.error(err);
                alert("Error generating Master Chart.");
            }
        }


        // --- ADD THIS FUNCTION TO YOUR SCRIPT SECTION ---
        async function trainAI() {
            const btn = document.querySelector('button[onclick="trainAI()"]');
            const statusDiv = document.getElementById("ai-status");

            // 1. UI Feedback
            btn.disabled = true;
            const originalText = btn.innerText;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Training...';
            statusDiv.innerHTML = "Initializing training sequence...";
            statusDiv.style.color = "#666";

            try {
                // 2. Call Backend
                const res = await fetch('/api/admin/train-ai');
                const data = await res.json();

                // 3. Handle Result
                if (res.ok) {
                    statusDiv.innerHTML = `<div class="alert alert-success" style="color: green; font-weight: bold; margin-top: 5px;">${data.message}</div>`;
                } else {
                    statusDiv.innerHTML = `<div class="alert alert-danger" style="color: red; margin-top: 5px;">Error: ${data.error || 'Unknown error'}</div>`;
                }
            } catch (err) {
                console.error(err);
                statusDiv.innerHTML = `<div class="alert alert-danger" style="color: red; margin-top: 5px;">Connection Error: Ensure backend is running.</div>`;
            } finally {
                // 4. Reset Button
                btn.disabled = false;
                btn.innerText = originalText;
            }
        }

        function downloadMasterPDF() {
            const element = document.getElementById('master-chart-preview');
            if (element.style.display === 'none') {
                alert("Please Generate the Master Chart Preview first!");
                return;
            }

            const examDate = document.getElementById("master_date").value || "Exam";
            const opt = {
                margin: 10,
                filename: `Master_Chart_${examDate}.pdf`,
                image: {
                    type: 'jpeg',
                    quality: 0.98
                },
                html2canvas: {
                    scale: 2
                },
                jsPDF: {
                    unit: 'mm',
                    format: 'a4',
                    orientation: 'landscape'
                }
            };

            html2pdf().set(opt).from(element).save();
        }

        // --- TEACHER & DUTY MANAGEMENT ---
        async function addTeacher(e) {
            e.preventDefault();
            const data = {
                name: document.getElementById("teach_name").value,
                employee_id: document.getElementById("teach_id").value,
                branch: document.getElementById("teach_branch").value,
                email: document.getElementById("teach_email").value
            };
            try {
                const res = await fetch('/api/admin/add-teacher', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (res.ok) {
                    alert("Teacher Added Successfully!");
                    loadTeachers(); // Refresh list
                    e.target.reset();
                } else {
                    alert("Error: " + result.error);
                }
            } catch (err) {
                alert("Server Error");
            }
        }

        // --- UPDATED LOAD TEACHERS FUNCTION ---
        async function loadTeachers() {
            try {
                const res = await fetch('/api/admin/get-all-teachers');
                const teachers = await res.json();

                // 1. Populate the "Select Teacher" Dropdown (for Duties)
                const sel = document.getElementById("duty_teacher_id");
                if (sel) {
                    sel.innerHTML = "<option value=''>-- Select Teacher --</option>";
                    teachers.forEach(t => {
                        sel.innerHTML += `<option value="${t.id}">${t.name} (${t.empid})</option>`;
                    });
                }

                // 2. Populate the "Teacher Directory" Table (Visual List)
                const tbody = document.getElementById("teacher-list-body");
                if (tbody) {
                    tbody.innerHTML = "";
                    if (teachers.length === 0) {
                        tbody.innerHTML = "<tr><td colspan='5' class='text-center'>No teachers found. Add one above!</td></tr>";
                    } else {
                        teachers.forEach(t => {
                            const tr = document.createElement("tr");
                            tr.innerHTML = `
                        <td><strong>${t.name}</strong></td>
                        <td>${t.empid}</td>
                        <td><span class="badge" style="background:#e0e7ff; color:#3730a3;">${t.branch}</span></td>
                        <td>${t.email || '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="deleteTeacher('${t.id}')" title="Delete Teacher">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    `;
                            tbody.appendChild(tr);
                        });
                    }
                }
            } catch (err) {
                console.error("Error loading teachers:", err);
            }
        }

        // --- ADD THIS DELETE FUNCTION IF MISSING ---
        async function deleteTeacher(id) {
            if (!confirm("Are you sure you want to delete this teacher? This might affect assigned duties.")) return;

            // Note: You might need to add this route to your backend if you haven't yet.
            // Assuming a generic delete route exists or you can add one.
            alert("Delete feature requires backend route '/api/admin/delete-teacher'. For now, data is safe.");
        }

        async function fetchExamsForDuty() {
            const roomId = document.getElementById("duty_room_id").value;
            const sel = document.getElementById("duty_exam_id");
            sel.innerHTML = "<option>Loading...</option>";

            try {
                const res = await fetch(`/api/admin/get-exams-in-room/${roomId}`);
                const exams = await res.json();
                sel.innerHTML = "<option value=''>-- Select Exam --</option>";
                exams.forEach(e => {
                    sel.innerHTML += `<option value="${e.id}">${e.name}</option>`;
                });
            } catch (err) {
                console.error(err);
            }
        }

        async function assignDuty(e) {
            e.preventDefault();
            const data = {
                room_id: document.getElementById("duty_room_id").value,
                exam_id: document.getElementById("duty_exam_id").value,
                teacher_id: document.getElementById("duty_teacher_id").value
            };
            try {
                const res = await fetch('/api/admin/assign-invigilator', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (res.ok) {
                    alert("Duty Assigned!");
                    loadDuties();
                } else {
                    alert("Error: " + result.error);
                }
            } catch (err) {
                alert("Server Error");
            }
        }

        async function loadDuties() {
            try {
                const res = await fetch('/api/admin/get-all-duties');
                const duties = await res.json();
                const tbody = document.getElementById("duties-table-body");
                if (!tbody) return;

                tbody.innerHTML = "";
                duties.forEach(d => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                <td>${d.teacher_name}</td>
                <td>${d.teacher_id}</td>
                <td>${d.exam_name}</td>
                <td>${d.date}</td>
                <td>${d.room}</td>
                <td><button onclick="deleteDuty(${d.id})" class="btn btn-sm btn-danger"><i class="fas fa-trash"></i></button></td>
            `;
                    tbody.appendChild(tr);
                });
            } catch (err) {
                console.error(err);
            }
        }

        async function deleteDuty(id) {
            if (!confirm("Remove this duty?")) return;
            await fetch('/api/admin/delete-duty', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    duty_id: id
                })
            });
            loadDuties();
        }

        // --- SYSTEM RESET ---
        async function resetSystem() {
            if (!confirm("‚ö†Ô∏è This will delete ALL Seating & Duties. Students/Teachers remain safe. Continue?")) return;
            try {
                const res = await fetch('/api/admin/reset-seating', {
                    method: 'POST'
                });
                const data = await res.json();
                alert(data.message || "System Reset Complete");
                location.reload();
            } catch (err) {
                alert("Reset Failed");
            }
        }

        async function resetDatabase() {
            if (!confirm("‚õî DANGER: This will delete ALL DATA (Students, Teachers, Exams). This cannot be undone!")) return;
            try {
                const res = await fetch('/api/admin/reset-database', {
                    method: 'POST'
                });
                const data = await res.json();
                alert(data.message);
                location.reload();
            } catch (err) {
                alert("Factory Reset Failed");
            }
        }

        // --- INIT ---
        window.onload = function() {
            console.log("System Loaded");
            loadRooms();
            loadTeachers();
            if (typeof loadTeachers === 'function') loadTeachers();
            setTimeout(loadStudents, 500);
            if (typeof loadDuties === 'function') loadDuties();
        };
    </script>
</body>

</html>