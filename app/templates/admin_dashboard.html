<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - ExamCell Pro</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        /* --- CORE LAYOUT --- */
        
        body {
            font-family: 'Inter', sans-serif;
            background: #f3f4f6;
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        
        .sidebar {
            width: 260px;
            background: #1e1e2f;
            flex-shrink: 0;
            color: white;
            height: 100%;
            padding: 20px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        /* Custom Scrollbar for Sidebar */
        
        .sidebar::-webkit-scrollbar {
            width: 6px;
        }
        
        .sidebar::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 3px;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 40px;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .nav-item {
            padding: 12px 15px;
            margin-bottom: 5px;
            color: #a0a0b0;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: 0.2s;
        }
        
        .nav-item:hover,
        .nav-item.active {
            background: #6366f1;
            color: white;
        }
        
        .nav-spacer {
            flex-grow: 1;
        }
        
        .main-content {
            flex: 1;
            min-width: 0;
            padding: 40px;
            overflow-y: auto;
            position: relative;
        }
        
        h2 {
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 10px;
            margin-bottom: 30px;
            color: #333;
        }
        
        h3 {
            margin-top: 0;
            color: #4b5563;
        }
        /* --- UI UTILITIES (Bootstrap Polyfills) --- */
        
        .mb-3 {
            margin-bottom: 1rem !important;
        }
        
        .mb-4 {
            margin-bottom: 1.5rem !important;
        }
        
        .m-0 {
            margin: 0 !important;
        }
        
        .mt-4 {
            margin-top: 1.5rem !important;
        }
        
        .text-primary {
            color: #6366f1 !important;
        }
        
        .text-secondary {
            color: #64748b !important;
        }
        
        .text-success {
            color: #10b981 !important;
        }
        
        .text-danger {
            color: #ef4444 !important;
        }
        
        .text-warning {
            color: #f59e0b !important;
        }
        
        .text-muted {
            color: #9ca3af !important;
        }
        
        .text-dark {
            color: #1f2937 !important;
        }
        
        .fw-bold {
            font-weight: 700 !important;
        }
        
        .border-start {
            border-left: 1px solid #dee2e6;
        }
        
        .border-4 {
            border-left-width: 4px !important;
        }
        
        .border {
            border: 1px solid #dee2e6 !important;
        }
        
        .border-warning {
            border-color: #f59e0b !important;
        }
        
        .border-danger {
            border-color: #ef4444 !important;
        }
        
        .border-dark {
            border-color: #1f2937 !important;
        }
        /* --- CARDS & FORMS --- */
        
        .card {
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        
        input,
        select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            background: white;
        }
        /* --- BUTTONS --- */
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            color: white;
            transition: 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn:hover {
            opacity: 0.9;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
        }
        
        .btn-primary {
            background: #6366f1;
        }
        
        .btn-success {
            background: #10b981;
        }
        
        .btn-warning {
            background: #f59e0b;
            color: #fff;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-dark {
            background: #1f2937;
            color: white;
        }
        
        .btn-light {
            background: #f8f9fa;
            color: #333;
            border: 1px solid #ddd;
        }
        
        .btn-light:hover {
            background: #e2e6ea;
        }
        
        .btn-outline-dark {
            background: transparent;
            border: 1px solid #333;
            color: #333;
        }
        
        .btn-outline-dark:hover {
            background: #333;
            color: white;
        }
        /* --- ALERTS & STATUS --- */
        
        #seating-result,
        #ai-status,
        #upload-status,
        #edit-notification {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }
        
        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }
        
        .alert-danger {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }
        /* --- TABLES & GRIDS --- */
        
        #seating-grid {
            display: grid;
            gap: 10px;
            margin-top: 20px;
            overflow-x: auto;
            padding-bottom: 20px;
        }
        /* DESIGNER GRID STYLES */
        
        #layout-preview {
            display: grid;
            gap: 5px;
            margin-top: 15px;
            margin-bottom: 20px;
        }
        
        .layout-box {
            width: 40px;
            height: 40px;
            background: #10b981;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.7rem;
            user-select: none;
        }
        
        .layout-box.disabled {
            background: #e5e7eb;
            color: #ccc;
        }
        /* --- IMPROVED TABLE STYLES --- */
        
        .table-responsive {
            overflow-x: auto;
            width: 100%;
            -webkit-overflow-scrolling: touch;
        }
        
        .duty-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
        }
        
        .duty-table th,
        .duty-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
            /* Centers content vertically */
            white-space: nowrap;
            /* Prevents weird text wrapping */
        }
        
        .duty-table th {
            background-color: #f8f9fa;
            color: #555;
            font-weight: 600;
        }
        /* Fix Email Column Overflow */
        
        .duty-table td:nth-child(4) {
            max-width: 180px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* Fix Action Column Alignment */
        
        .duty-table th:last-child,
        .duty-table td:last-child {
            text-align: center;
            width: 100px;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 8px;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 4px;
        }
        /* --- NOTICE BOARD STYLES --- */
        
        .notice-container {
            background: white;
            padding: 40px;
            max-width: 1000px;
            margin: 0 auto;
            display: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .exam-header {
            text-align: center;
            margin-bottom: 20px;
            text-transform: uppercase;
            line-height: 1.4;
        }
        
        .exam-header h1 {
            margin: 0;
            font-size: 24px;
            text-decoration: underline;
            color: #000;
        }
        
        .exam-header h2 {
            margin: 5px 0;
            font-size: 18px;
            text-decoration: underline;
            color: #000;
        }
        
        .exam-header p {
            margin: 5px 0;
            font-weight: bold;
            color: #000;
        }
        
        .notice-table {
            width: 100%;
            border-collapse: collapse;
            font-family: Arial, sans-serif;
            font-size: 14px;
            color: #000;
        }
        
        .notice-table th,
        .notice-table td {
            border: 1px solid black;
            padding: 8px 12px;
            vertical-align: middle;
        }
        
        .notice-table th {
            background-color: #f0f0f0;
            font-weight: bold;
            text-transform: uppercase;
            text-align: left;
        }
        
        .range-cell {
            display: flex;
            justify-content: space-between;
        }
        
        .total-row {
            font-weight: bold;
            text-align: right;
            padding-right: 20px;
        }
        
        .hall-cell {
            text-align: center;
            font-weight: bold;
            font-size: 16px;
        }
        
        .grand-total {
            background: #f9f9f9;
            font-weight: bold;
            font-size: 15px;
        }
        /* --- ATTENDANCE SHEET STYLES --- */
        
        .att-sheet {
            background: white;
            padding: 20px;
            font-family: 'Times New Roman', serif;
            color: black;
            display: block;
            page-break-after: always;
        }
        
        .att-title {
            text-align: center;
            font-weight: bold;
            text-decoration: underline;
            font-size: 20px;
            margin-bottom: 5px;
        }
        
        .att-sub {
            text-align: center;
            font-weight: bold;
            font-size: 16px;
            margin: 2px;
        }
        
        .att-meta {
            width: 100%;
            margin: 20px 0;
            font-weight: bold;
            font-size: 14px;
        }
        
        .att-meta td {
            padding: 2px 0;
            border: none;
        }
        
        .att-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        
        .att-table th,
        .att-table td {
            border: 1px solid black;
            padding: 5px;
            text-align: center;
        }
        
        .att-table th {
            font-weight: bold;
            background-color: #fff;
        }
        
        .att-left {
            text-align: left !important;
            padding-left: 5px;
        }
        
        .att-footer {
            width: 100%;
            margin-top: 20px;
            font-weight: bold;
            font-size: 14px;
        }
        
        .att-footer td {
            padding: 10px;
            border: 1px solid black;
        }
        /* --- QUESTION DISTRIBUTION STYLES --- */
        
        .dist-table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'Times New Roman', serif;
            color: #000;
        }
        
        .dist-table th,
        .dist-table td {
            border: 1px solid black;
            padding: 8px 10px;
            font-size: 15px;
        }
        
        .dist-table th {
            background: #f0f0f0;
            text-align: center;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .dist-table td {
            vertical-align: top;
        }
        
        .dist-header {
            text-align: center;
            margin-bottom: 20px;
            font-family: 'Times New Roman', serif;
            text-transform: uppercase;
            color: #000;
        }
        
        .dist-header h2 {
            border: none;
            margin: 0;
            font-size: 20px;
            font-weight: bold;
            text-decoration: underline;
            padding: 0;
        }
        
        .dist-header h3 {
            margin: 5px 0;
            font-size: 16px;
            font-weight: bold;
        }
        
        .dist-header p {
            margin: 5px 0;
            font-weight: bold;
        }
        /* --- MASTER CHART STYLES --- */
        
        .master-container {
            background: white;
            padding: 20px;
            font-family: 'Times New Roman', serif;
            color: black;
            display: none;
            width: 100%;
            box-sizing: border-box;
        }
        
        .master-header {
            text-align: center;
            margin-bottom: 15px;
            font-weight: bold;
            font-size: 18px;
        }
        
        .master-header .inst-name {
            font-size: 22px;
            text-decoration: underline;
            margin-bottom: 5px;
        }
        
        .master-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        .master-table th,
        .master-table td {
            border: 1px solid black;
            padding: 6px;
            text-align: center;
        }
        
        .master-table th {
            background-color: #f0f0f0;
            font-weight: bold;
        }
        
        .master-footer {
            margin-top: 20px;
            font-weight: bold;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        /* --- UNIVERSAL PRINT STYLES --- */
        
        @media print {
            @page {
                size: landscape;
                margin: 5mm;
            }
            body {
                background: white;
                height: auto;
                overflow: visible;
            }
            /* Hide Navigation and UI Elements */
            .sidebar,
            .nav-item,
            .btn,
            .card,
            h2,
            h4,
            .form-grid,
            .logo,
            #ai-status,
            #upload-status,
            #edit-notification,
            .nav-spacer,
            #student_search {
                display: none !important;
            }
            /* Reset Main Content constraints */
            .main-content {
                margin: 0;
                padding: 0;
                overflow: visible;
                flex: none;
                width: 100%;
                height: auto;
            }
            /* Ensure the content containers expand to full width */
            .content-section,
            #notice-container,
            #attendance-preview,
            #distribution-preview,
            .att-sheet,
            #master-chart-preview {
                width: 100% !important;
                box-shadow: none !important;
                margin: 0 !important;
                padding: 0 !important;
                overflow: visible !important;
                display: block !important;
            }
            /* Force tables to have dark borders */
            table,
            th,
            td {
                border-color: #000 !important;
            }
        }
    </style>
</head>

<body>

    <div class="sidebar">
        <div class="logo"><i class="fas fa-shield-alt"></i> ExamControl</div>
        <div class="nav-item active" onclick="showSection('room-section')"><i class="fas fa-door-open"></i> Manage Rooms
        </div>
        <div class="nav-item" onclick="showSection('student-section')"><i class="fas fa-user-graduate"></i> Manage Students
        </div>
        <div class="nav-item" onclick="showSection('seating-section')"><i class="fas fa-users-cog"></i> Generate Seating
        </div>
        <div class="nav-item" onclick="showSection('chart-section')"><i class="fas fa-th"></i> View Seating Chart</div>
        <div class="nav-item" onclick="showSection('notice-section')"><i class="fas fa-clipboard-list"></i> Seat Plan Notice
        </div>
        <div class="nav-item" onclick="showSection('attendance-section')"><i class="fas fa-file-signature"></i> Attendance Sheet</div>
        <div class="nav-item" onclick="showSection('distribution-section')"><i class="fas fa-file-invoice"></i> Question Distribution
        </div>

        <div class="nav-item" onclick="showSection('master-chart-section')"><i class="fas fa-table"></i> Master Chart
        </div>

        <div class="nav-item" onclick="showSection('ai-section')"><i class="fas fa-brain"></i> AI Model Training</div>
        <div class="nav-item" onclick="showSection('teacher-section')"><i class="fas fa-chalkboard-teacher"></i> Teachers & Duties</div>

        <div class="nav-item" onclick="showSection('settings-section')"><i class="fas fa-cogs"></i> Settings & Reset
        </div>

        <div class="nav-spacer"></div>
        <div class="nav-item" onclick="resetSystem()" style="color: #ef4444; font-weight: bold; border-top: 1px solid #333; margin-top: 10px;"><i class="fas fa-trash-alt"></i> Quick Reset</div>
        <div class="nav-item" style="color: #ff6b6b;" onclick="location.href='/api/landing'"><i class="fas fa-sign-out-alt"></i> Logout</div>
    </div>

    <div class="main-content">

        <div id="room-section" class="content-section">
            <h2>Manage Examination Halls</h2>

            <div class="card">
                <h3><i class="fas fa-chart-pie"></i> Room Overview</h3>

                <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                    <div style="background: #eff6ff; padding: 20px; border-radius: 10px; flex: 1; text-align: center; border: 1px solid #dbeafe;">
                        <h4 style="margin:0; color: #1e40af; font-size: 14px; text-transform: uppercase;">Total Rooms</h4>
                        <div id="stat-total-rooms" style="font-size: 32px; font-weight: 800; color: #1e3a8a; margin-top: 5px;">0
                        </div>
                    </div>
                    <div style="background: #ecfdf5; padding: 20px; border-radius: 10px; flex: 1; text-align: center; border: 1px solid #d1fae5;">
                        <h4 style="margin:0; color: #065f46; font-size: 14px; text-transform: uppercase;">Total Seating Strength
                        </h4>
                        <div id="stat-total-capacity" style="font-size: 32px; font-weight: 800; color: #064e3b; margin-top: 5px;">0
                        </div>
                    </div>
                </div>

                <h4 style="color: #4b5563; margin-bottom: 10px;">üìã Room List</h4>
                <div class="table-responsive" style="max-height: 300px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px;">
                    <table class="duty-table" style="margin-top: 0;">
                        <thead style="position: sticky; top: 0; z-index: 5;">
                            <tr>
                                <th>Building</th>
                                <th>Room Name</th>
                                <th>Capacity</th>
                                <th style="text-align: center;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="room-list-table-body">
                            <tr>
                                <td colspan="4" class="text-center">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <h4 class="mb-3 text-primary">Add New Room (Layout Designer)</h4>
                <form id="addRoomForm" onsubmit="addRoom(event)">
                    <div class="form-grid">
                        <div><label>Building Name</label><input type="text" id="building_name" placeholder="e.g. Science Block" required></div>
                        <div><label>Room Name</label><input type="text" id="room_name" placeholder="e.g. Hall 101" required></div>
                    </div>
                    <div class="form-grid">
                        <div><label>Max Rows</label><input type="number" id="rows" value="10" required></div>
                        <div><label>Max Columns</label><input type="number" id="cols" value="6" required></div>
                    </div>
                    <button type="button" class="btn btn-dark w-100 mb-3" onclick="generateLayoutGrid()">Step 1:
                        Generate Grid</button>
                    <div id="layout-container" style="display: none;">
                        <p class="text-center text-muted small">Click seats to Disable/Enable (Gray = Empty Space)</p>
                        <div id="layout-preview" style="justify-content: center;"></div>
                        <button type="submit" class="btn btn-primary w-100">Step 2: Save Room</button>
                    </div>
                </form>
            </div>
            <div class="card" style="border-left: 5px solid #f59e0b;">
                <h4 style="color: #d97706; margin-top: 0;">Edit Room Dimensions</h4>
                <form id="editRoomForm" onsubmit="updateRoom(event)">
                    <div class="form-grid">
                        <div style="grid-column: span 2;"><label>Select Room to Edit</label><select id="edit_room_id" required>
                                <option value="">-- Select Room --</option>
                            </select></div>
                    </div>
                    <div class="form-grid">
                        <div><label>New Rows</label><input type="number" id="edit_rows" required></div>
                        <div><label>New Columns</label><input type="number" id="edit_cols" required></div>
                    </div>
                    <button type="submit" class="btn btn-warning">Update Dimensions</button>
                </form>
                <div id="edit-notification"></div>
            </div>
        </div>

        <div id="student-section" class="content-section" style="display: none;">
            <h2>Manage Students</h2>
            <div class="card">
                <h3><i class="fas fa-file-csv"></i> Bulk Upload Students</h3>
                <form onsubmit="uploadCSV(event)">
                    <div class="form-grid">
                        <div><label>Select CSV File (headers: name, roll_no, branch, batch)</label><input type="file" id="csv_file" accept=".csv" required></div>
                    </div>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-cloud-upload-alt"></i> Upload
                        Students</button>
                </form>
                <div id="upload-status"></div>
            </div>

            <div class="card border-start border-4 border-danger">
                <h4 class="text-danger" style="margin-top:0;"><i class="fas fa-layer-group"></i> Batch Management</h4>
                <p class="text-muted" style="font-size: 0.9rem; margin-bottom: 15px;">
                    Permanently delete all students belonging to a specific session (e.g., 2023-2027). This action cannot be undone.
                </p>
                <div style="display: flex; gap: 15px; align-items: flex-end;">
                    <div style="flex: 1;">
                        <label>Target Session to Delete</label>
                        <input type="text" id="delete_target_session" placeholder="e.g. 2023-2027">
                    </div>
                    <button onclick="deleteBatch()" class="btn btn-danger">
                        <i class="fas fa-trash"></i> Delete Entire Batch
                    </button>
                </div>
            </div>

            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3><i class="fas fa-users"></i> Student Database</h3>
                    <button onclick="toggleStudentForm()" class="btn btn-success"><i class="fas fa-plus"></i> Add New
                        Student</button>
                </div>

                <div id="student-form-container" style="display: none; background: #f9fafb; padding: 20px; border-radius: 8px; border: 1px solid #e5e7eb; margin-bottom: 20px;">
                    <h4 id="form-title" style="margin-top: 0; color: #4f46e5;">Add Student</h4>
                    <form onsubmit="handleStudentSave(event)">
                        <input type="hidden" id="stud_id">
                        <div class="form-grid">
                            <div><label>Full Name</label><input type="text" id="stud_name" required></div>
                            <div><label>Registration Number</label><input type="text" id="stud_reg_no" placeholder="Leave blank to use Roll No"></div>
                        </div>
                        <div class="form-grid">
                            <div><label>Roll Number</label><input type="text" id="stud_roll" required></div>
                            <div><label>Branch</label><input type="text" id="stud_branch" placeholder="e.g. CSE, IT" required></div>
                        </div>
                        <div class="form-grid">
                            <div><label>Batch/Session</label><input type="text" id="stud_session" placeholder="e.g. 2023-2027" required>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button type="submit" class="btn btn-primary" id="save-btn">Save Student</button>
                            <button type="button" class="btn btn-dark" onclick="toggleStudentForm()">Cancel</button>
                        </div>
                    </form>
                </div>

                <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <input type="text" id="student_search" placeholder="Search by Name or Roll No..." onkeyup="filterStudents()" style="padding: 10px; flex: 2; border: 1px solid #ccc; border-radius: 6px; min-width: 200px;">

                    <select id="filter_session" onchange="filterStudents()" style="padding: 10px; flex: 1; border: 1px solid #ccc; border-radius: 6px; min-width: 150px;">
                        <option value="">All Sessions</option>
                    </select>

                    <div style="white-space: nowrap; padding: 0 5px;">
                        <input type="checkbox" id="filter_temp_reg" onchange="filterStudents()" style="width: auto; margin-right: 5px;">
                        <label for="filter_temp_reg" style="display: inline; cursor: pointer; font-weight: 600; color: #d97706;">
                            Temp. IDs Only
                        </label>
                    </div>
                </div>

                <div class="table-responsive" style="max-height: 500px;">
                    <table class="duty-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Reg No</th>
                                <th>Branch</th>
                                <th>Batch</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="student-table-body">
                            <tr>
                                <td colspan="5" class="text-center">Loading students...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="seating-section" class="content-section" style="display: none;">
            <h2>Auto-Generate Seating</h2>
            <div class="card">
                <form id="seatingForm" onsubmit="generateSeating(event)">
                    <div class="form-grid">
                        <div><label>Select Room</label><select id="target_room_id" required>
                                <option>-- Loading... --</option>
                            </select></div>
                        <div><label>Exam Name</label><input type="text" id="exam_name" required></div>
                    </div>
                    <div class="form-grid">
                        <div><label>Exam Date</label><input type="date" id="exam_date" required></div>
                        <div><label>Time Slot</label><input type="text" id="exam_time" required></div>
                    </div>

                    <div class="form-grid">
                        <div><label>Batch (required)</label><input type="text" id="target_session"></div>

                        <div>
                            <label>Semester</label>
                            <select id="gen_semester" required>
                                <option value="">-- Select --</option>
                                <option value="1st Sem">1st Semester</option>
                                <option value="2nd Sem">2nd Semester</option>
                                <option value="3rd Sem">3rd Semester</option>
                                <option value="4th Sem">4th Semester</option>
                                <option value="5th Sem">5th Semester</option>
                                <option value="6th Sem">6th Semester</option>
                                <option value="7th Sem">7th Semester</option>
                                <option value="8th Sem">8th Semester</option>
                            </select>
                        </div>

                        <div>
                            <label>Branches (Comma Separated)</label>
                            <div style="display:flex; gap:5px;">
                                <input type="text" id="branches_input" required placeholder="CSE, ECE or 'ALL'">
                                <button type="button" class="btn btn-dark" style="padding: 0 10px;" onclick="setAllBranches()" title="Select All Branches">ALL</button>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label>Max Branches Per Room</label>
                        <select id="max_branches">
                            <option value="0" selected>-- No Limit --</option>
                            <option value="1">1 Branch Only</option>
                            <option value="2">Max 2 Branches</option>
                            <option value="3">Max 3 Branches</option>
                            <option value="4">Max 4 Branches</option>
                        </select>
                    </div>

                    <div style="background: #e0f2fe; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #bae6fd;">
                        <h4 style="margin-top: 0; color: #0369a1; font-size: 1rem;"><i class="fas fa-calculator"></i> Live Availability</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9rem;">
                            <div><strong>Capacity:</strong> <span id="stat_room_cap">-</span></div>
                            <div><strong>Selected:</strong> <span id="stat_selected">0</span></div>
                            <div><strong>Status:</strong> <span id="stat_status">Waiting...</span></div>
                        </div>
                        <div style="border-top: 1px solid #bae6fd; padding-top: 10px; margin-top: 10px;"><strong style="color: #555; font-size: 0.85rem;">Branch Breakdown:</strong>
                            <div id="stat_breakdown" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 5px;">
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success">Run Seating Algorithm</button>
                </form>
                <div id="seating-result"></div>
            </div>
        </div>

        <div id="notice-section" class="content-section" style="display: none;">
            <h2>Print Seating Plan Notice</h2>
            <div class="card">
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div>
                        <label>Select Date</label>
                        <input type="date" id="notice_date" onchange="fetchExamTimesForNotice()">
                    </div>

                    <div>
                        <label>Select Time Slot</label>
                        <select id="notice_time">
                            <option value="">-- Select Date First --</option>
                        </select>
                    </div>

                    <div><label>Select Batch</label><input type="text" id="notice_batch" placeholder="e.g. 2023-2027"></div>
                    <div>
                        <label>Select Semester</label>
                        <select id="notice_semester">
                            <option value="">-- Select --</option>
                            <option value="1st">1st Semester</option>
                            <option value="2nd">2nd Semester</option>
                            <option value="3rd">3rd Semester</option>
                            <option value="4th">4th Semester</option>
                            <option value="5th">5th Semester</option>
                            <option value="6th">6th Semester</option>
                            <option value="7th">7th Semester</option>
                            <option value="8th">8th Semester</option>
                        </select>
                    </div>
                    <div>
                        <label>Select Room</label>
                        <select id="notice_room_id">
                            <option value="">-- All Rooms --</option>
                        </select>
                    </div>
                    <div>
                        <label>Sort By</label>
                        <select id="notice_id_type">
                            <option value="reg" selected>Registration Number</option>
                            <option value="roll">Roll Number</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="generateNotice()">Generate Notice</button>
                <button class="btn btn-dark" onclick="printNotice()" style="margin-left: 10px;"><i
                        class="fas fa-print"></i> Print Notice</button>
            </div>

            <div id="notice-container" class="notice-container">
                <div class="exam-header">
                    <h1>BIT SINDRI</h1>
                    <h2>SEAT - PLAN</h2>
                    <p id="notice-exam-title">Semester Examination</p>
                    <p>Timing: <span id="notice-timing">10:00 AM To 01:00 PM</span></p>
                </div>

                <table class="notice-table">
                    <thead>
                        <tr>
                            <th style="width: 25%;">BRANCH</th>
                            <th style="width: 55%;">ROLL NUMBER</th>
                            <th style="width: 20%;">HALL NO.</th>
                        </tr>
                    </thead>
                    <tbody id="notice-body">
                    </tbody>
                </table>

                <div style="margin-top: 20px; font-size: 12px; color: #000;">
                    <strong>Note:</strong><br> 1. Examinees are required to bring their properly updated ‚ÄúLIBRARY CARD/ COLLEGE ADMISSION RECEIPT/IDENTITY CARD‚Äù on each day of examination, without which he/she may not be allowed to appear.
                    <br> 2. Mobile phone/ Smart Watch are strictly prohibited. Keeping mobile phone during the exam, may lead scratching of the answer sheet or Unfair Means.<br> 3. After 15 minutes of commencement of examination, No Examinee will be allowed
                    to enter the Examination Hall. 4. Answer sheet submission will be allowed only after 45 minutes.<br>
                    <br> Copy to: 1) Concerned Head of the Departments; 2) Dean (Academic); 3) Main Notice Board; 4) PA to Director, BIT Sindri for information<br>
                    <br>
                    <br>
                    <b>Prof. In Charge, Exam</b><br> BIT Sindri.
                    <br>
                </div>
            </div>
        </div>

        <div id="attendance-section" class="content-section" style="display: none;">
            <h2>Generate Attendance Sheet</h2>
            <div class="card">
                <div class="form-grid">
                    <div>
                        <label>Date</label>
                        <input type="date" id="att_date" onchange="fetchExamTimesForAttendance()">
                    </div>

                    <div>
                        <label>Time Slot</label>
                        <select id="att_time">
                            <option value="">-- Select Date First --</option>
                        </select>
                    </div>

                    <div>
                        <label>Number of Subjects (Columns)</label>
                        <select id="att_subject_count">
                            <option value="1">1 Subject</option>
                            <option value="2">2 Subjects</option>
                            <option value="3" selected>3 Subjects</option>
                            <option value="4">4 Subjects</option>
                            <option value="5">5 Subjects</option>
                            <option value="6">6 Subjects</option>
                        </select>
                    </div>

                    <div><label>Room</label><select id="att_room_id">
                            <option value="">-- Select Room --</option>
                        </select></div>
                </div>

                <button class="btn btn-primary" onclick="generateAttendance()">Generate Preview</button>
                <button class="btn btn-dark" onclick="printSection('attendance-preview')" style="margin-left: 10px;">
                    <i class="fas fa-print"></i> Print
                </button>
            </div>
        </div>

        <div id="attendance-preview"></div>

        <div id="distribution-section" class="content-section" style="display: none;">
            <h2>Question Paper Distribution</h2>
            <div class="card">
                <div class="form-grid">
                    <div>
                        <label>Date</label>
                        <input type="date" id="dist_date" onchange="fetchExamTimesForDistribution()">
                    </div>

                    <div>
                        <label>Time Slot</label>
                        <select id="dist_time">
                            <option value="">-- Select Date First --</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="generateDistribution()">Generate Chart</button>
                <button class="btn btn-dark" onclick="printSection('distribution-preview')" style="margin-left: 10px;">
                    <i class="fas fa-print"></i> Print Chart
                </button>
            </div>

            <div id="distribution-preview" style="background: white; padding: 40px; margin-top: 20px; display: none;">

                <div class="dist-header">
                    <h2>QUESTION DISTRIBUTION</h2>
                    <h3>B.I.T , SINDRI</h3>
                    <p id="dist-exam-name">Semester Examination</p>
                    <p>(JUT Ranchi)</p>
                    <p>Timing: <span id="dist-exam-time">--:--</span></p>
                </div>

                <table class="dist-table">
                    <thead>
                        <tr>
                            <th style="width: 10%;">Sl. No.</th>
                            <th style="width: 25%;">Branch</th>
                            <th style="width: 65%;">Hall No. & Quantity</th>
                        </tr>
                    </thead>
                    <tbody id="dist-body">
                    </tbody>
                </table>
            </div>
        </div>

        <div id="master-chart-section" class="content-section" style="display: none;">
            <h2>Master Seating Chart</h2>
            <div class="card">
                <div class="form-grid">
                    <div>
                        <label>Date</label>
                        <input type="date" id="master_date" onchange="fetchExamTimesForMasterChart()">
                    </div>

                    <div>
                        <label>Time Slot</label>
                        <select id="master_time">
                            <option value="">-- Select Date First --</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="generateMasterChart()">Generate Master Chart</button>
                <button class="btn btn-dark" onclick="printSection('master-chart-preview')" style="margin-left: 10px;">
                    <i class="fas fa-print"></i> Print Master Chart
                </button>
            </div>

            <div id="master-chart-preview" class="master-container">
                <div class="master-header">
                    <div class="inst-name">BIT, Sindri</div>
                    <div id="master-exam-title">B. Tech Semester Examination</div>
                    <div>Timing: <span id="master-exam-timing">--</span></div>
                </div>

                <table class="master-table">
                    <thead>
                        <tr id="master-table-head">
                        </tr>
                    </thead>
                    <tbody id="master-table-body">
                    </tbody>
                </table>

                <div class="master-footer">
                    <div>Total Present: <span id="master-total-present" style="margin-left: 10px;">0</span></div>
                    <div>Total Absent: <span style="margin-left: 10px; border-bottom: 1px dotted #000; width: 50px; display: inline-block;"></span>
                    </div>
                    <div>Unfair Means: <span style="margin-left: 10px; border-bottom: 1px dotted #000; width: 50px; display: inline-block;"></span>
                    </div>
                </div>
            </div>
        </div>


        <div id="chart-section" class="content-section" style="display: none;">
            <h2>Visual Seating Arrangement</h2>
            <div class="card">
                <div class="form-grid">
                    <div><label>Select Room</label><select id="chart_room_id" onchange="fetchExamsForRoom()">
                        <option>-- Loading... --</option>
                    </select></div>
                    <div><label>Select Session</label><select id="chart_exam_id" disabled>
                        <option>-- Select Room First --</option>
                    </select></div>
                </div>
                <div class="form-grid">
                    <div style="display: flex; gap: 10px; grid-column: span 2;"><button onclick="loadChart()" class="btn btn-primary" style="flex: 1;">Load Visual Map</button><button onclick="downloadPDF()" class="btn btn-dark" style="flex: 1;"><i class="fas fa-file-pdf"></i> PDF</button></div>
                </div>
                <div id="seating-grid"></div>
            </div>
        </div>

        <div id="ai-section" class="content-section" style="display: none;">
            <h2>AI Model Management</h2>
            <div class="card"><button onclick="trainAI()" class="btn btn-warning">Retrain AI Model Now</button>
                <div id="ai-status"></div>
            </div>
        </div>

        <div id="teacher-section" class="content-section" style="display: none;">
            <h2>Manage Teachers & Invigilators</h2>

            <div class="card mb-4">
                <h4 class="text-primary mb-3">Add New Teacher</h4>
                <form onsubmit="addTeacher(event)">
                    <div class="form-grid">
                        <div><label>Full Name</label><input type="text" id="teach_name" required></div>
                        <div><label>Employee ID</label><input type="text" id="teach_id" placeholder="e.g. T-101" required>
                        </div>
                    </div>
                    <div class="form-grid">
                        <div><label>Branch</label><input type="text" id="teach_branch" required></div>
                        <div><label>Email</label><input type="email" id="teach_email"></div>
                    </div>
                    <button type="submit" class="btn btn-primary">Add Teacher</button>
                </form>
            </div>

            <div class="card mb-4">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h4 class="m-0 text-secondary">üìã Teacher Directory</h4>
                    <button onclick="loadTeachers()" class="btn btn-sm btn-light border"><i class="fas fa-sync"></i>
                    Refresh</button>
                </div>
                <div class="table-responsive">
                    <table class="duty-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Emp ID</th>
                                <th>Branch</th>
                                <th>Email</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="teacher-list-body">
                            <tr>
                                <td colspan="5" class="text-center">Loading teachers...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card border-start border-4 border-warning mb-4">
                <h4 class="text-warning mb-3">Assign Invigilation Duty</h4>
                <form onsubmit="assignDuty(event)">
                    <div class="form-grid">
                        <div><label>Select Room</label><select id="duty_room_id" onchange="fetchExamsForDuty()" required>
                            <option>-- Select Room --</option>
                        </select></div>
                        <div><label>Select Exam</label><select id="duty_exam_id" required>
                            <option>-- Select Room First --</option>
                        </select></div>
                    </div>
                    <div class="form-grid">
                        <div style="grid-column: span 2;"><label>Select Teacher</label><select id="duty_teacher_id" required>
                            <option>-- Loading Teachers... --</option>
                        </select></div>
                    </div>
                    <button type="submit" class="btn btn-warning text-white fw-bold">Assign Duty</button>
                </form>
            </div>
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h4><i class="fas fa-list"></i> Duty Roster</h4><button onclick="loadDuties()" class="btn btn-sm btn-outline-dark"><i class="fas fa-sync"></i> Refresh</button>
                </div>
                <div class="table-responsive">
                    <table class="duty-table">
                        <thead>
                            <tr>
                                <th>Teacher Name</th>
                                <th>ID</th>
                                <th>Exam</th>
                                <th>Date & Time</th>
                                <th>Room</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="duties-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="settings-section" class="content-section" style="display: none;">
            <h2>Settings & Maintenance</h2>
            <div class="card border-start border-4 border-danger">
                <h3 class="text-danger"><i class="fas fa-exclamation-triangle"></i> End of Semester Wipe</h3>
                <p style="color: #666; margin-bottom: 20px;">
                    Use the button below to clear old examination data (seating plans, schedules, duties). This action is
                    <strong>irreversible</strong> but keeps Students and Teachers safe.
                </p>
                <button onclick="resetSystem()" class="btn btn-danger" style="font-weight: bold; font-size: 16px;">
                <i class="fas fa-trash-alt"></i> WIPE EXAM DATA (Safe Reset)
            </button>
            </div>

            <div class="card border-start border-4 border-dark mt-4" style="background-color: #fef2f2;">
                <h3 class="text-dark"><i class="fas fa-skull-crossbones"></i> Factory Reset (Danger Zone)</h3>
                <p style="color: #991b1b; margin-bottom: 20px;">
                    <strong>WARNING:</strong> This will permanently delete <strong>ALL</strong> data including Students, Teachers, Rooms, Exams, and Seating Plans. Use this only if you want to set up the system from scratch.
                </p>
                <button onclick="resetDatabase()" class="btn btn-dark" style="font-weight: bold; font-size: 16px; background: #000;">
                <i class="fas fa-bomb"></i> FACTORY RESET (DELETE EVERYTHING)
            </button>
            </div>
        </div>

    </div>

    <script>
        let layoutState = [];
        let allStudents = [];

        window.onload = async function() {
            await loadRooms();
            await loadTeachers();
            loadDuties();
            loadStudents(); // Added from old file
            document.getElementById('target_room_id').addEventListener('change', updateStats);
            document.getElementById('target_session').addEventListener('input', updateStats);
            document.getElementById('branches_input').addEventListener('input', updateStats);
        };

        function showSection(id) {
            document.querySelectorAll('.content-section').forEach(el => el.style.display = 'none');
            document.getElementById(id).style.display = 'block';
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const navs = document.querySelectorAll('.nav-item');

            // Adjusted Indices for Navigation Highlighting
            if (id === 'room-section') navs[0].classList.add('active');
            if (id === 'student-section') navs[1].classList.add('active');
            if (id === 'seating-section') navs[2].classList.add('active');
            if (id === 'chart-section') navs[3].classList.add('active');
            if (id === 'notice-section') navs[4].classList.add('active');
            if (id === 'attendance-section') navs[5].classList.add('active');
            if (id === 'distribution-section') navs[6].classList.add('active');
            if (id === 'master-chart-section') navs[7].classList.add('active');
            if (id === 'ai-section') navs[8].classList.add('active');
            if (id === 'teacher-section') navs[9].classList.add('active');
            // Settings is index 10
            if (id === 'settings-section') navs[10].classList.add('active');

            // Refresh specific data when section opens
            if (id === 'teacher-section') loadTeachers();
            if (id === 'student-section') loadStudents();
        }

        async function loadRooms() {
            try {
                const res = await fetch('/api/admin/get-all-rooms');
                const rooms = await res.json();

                // --- 1. UPDATE STATISTICS UI ---
                const totalRooms = rooms.length;
                const totalCapacity = rooms.reduce((sum, room) => sum + (room.capacity || 0), 0);

                document.getElementById('stat-total-rooms').innerText = totalRooms;
                document.getElementById('stat-total-capacity').innerText = totalCapacity;

                // --- 2. POPULATE ROOM LIST TABLE ---
                const tbody = document.getElementById('room-list-table-body');
                tbody.innerHTML = '';

                if (rooms.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center">No rooms found. Add one below.</td></tr>';
                } else {
                    rooms.forEach(room => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td><span class="badge bg-secondary text-white">${room.building || 'Main'}</span></td>
                            <td><strong>${room.name}</strong></td>
                            <td>${room.capacity} Seats</td>
                            <td style="text-align: center;">
                                <button class="btn btn-sm btn-outline-dark" onclick="alert('Use the Edit form below to modify ID: ${room.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                }

                // --- 3. POPULATE DROPDOWNS (Existing Logic) ---
                const dropdowns = ['target_room_id', 'chart_room_id', 'notice_room_id', 'att_room_id', 'duty_room_id', 'edit_room_id'];

                dropdowns.forEach(id => {
                    const select = document.getElementById(id);
                    if (!select) return;

                    // Clear and add default option
                    select.innerHTML = `<option value="">-- Select --</option>`;

                    // Special "All Rooms" Logic for Auto-Seating
                    if (id === 'target_room_id') {
                        const allOpt = document.createElement('option');
                        allOpt.value = "all";
                        allOpt.text = "‚ö° Auto-Allocate (All Rooms)";
                        select.appendChild(allOpt);
                    }
                    // Logic for Notice Board
                    if (id === 'notice_room_id') {
                        const allOpt = document.createElement('option');
                        allOpt.value = "";
                        allOpt.text = "-- All Rooms --";
                        select.appendChild(allOpt);
                    }
                    // Logic for Attendance
                    if (id === 'att_room_id') {
                        const allOpt = document.createElement('option');
                        allOpt.value = "all";
                        allOpt.text = "üñ®Ô∏è All Rooms (Batch Print)";
                        allOpt.style.fontWeight = "bold";
                        select.appendChild(allOpt);
                    }
                    // Logic for Visual Chart (Campus View)
                    if (id === 'chart_room_id') {
                        const allOpt = document.createElement('option');
                        allOpt.value = "0";
                        allOpt.text = "‚ö° All Rooms (Campus View)";
                        allOpt.style.fontWeight = "bold";
                        select.appendChild(allOpt);
                    }

                    // Add individual rooms
                    rooms.forEach(room => {
                        const option = document.createElement('option');
                        option.value = room.id;
                        option.text = `${room.building} - ${room.name} (Cap: ${room.capacity})`;
                        option.setAttribute('data-capacity', room.capacity);
                        select.appendChild(option);
                    });
                });
            } catch (err) {
                console.error(err);
                alert("Error loading room data.");
            }
        }

        async function loadTeachers() {
            try {
                const res = await fetch('/api/admin/get-all-teachers');
                const teachers = await res.json();

                // 1. Populate Dropdown for Duties
                const select = document.getElementById('duty_teacher_id');
                if (select) {
                    select.innerHTML = '<option value="">-- Select Teacher --</option>';
                    teachers.forEach(t => {
                        const opt = document.createElement('option');
                        opt.value = t.id;
                        opt.text = `${t.name} (${t.empid}) - ${t.branch}`;
                        select.appendChild(opt);
                    });
                }

                // 2. Populate Teacher Directory Table
                const tbody = document.getElementById('teacher-list-body');
                if (tbody) {
                    tbody.innerHTML = '';
                    if (teachers.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No teachers found.</td></tr>';
                    } else {
                        teachers.forEach(t => {
                            const row = `
                                <tr>
                                    <td><strong>${t.name}</strong></td>
                                    <td><span class="badge bg-secondary text-white">${t.employee_id || t.empid}</span></td>
                                    <td>${t.branch}</td>
                                    <td>${t.email || '-'}</td>
                                    <td>
                                        <button onclick="deleteTeacher(${t.id})" class="btn btn-sm btn-danger" title="Remove Teacher">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </td>
                                </tr>
                            `;
                            tbody.innerHTML += row;
                        });
                    }
                }
            } catch (err) {
                console.error(err);
            }
        }

        async function loadDuties() {
            try {
                const res = await fetch('/api/admin/get-all-duties');
                const duties = await res.json();
                const tbody = document.getElementById('duties-table-body');
                tbody.innerHTML = '';
                if (duties.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No duties assigned yet.</td></tr>';
                    return;
                }

                duties.forEach(d => {
                    tbody.innerHTML += `
                    <tr>
                        <td>${d.teacher_name}</td>
                        <td>${d.teacher_id}</td>
                        <td>${d.exam_name}</td>
                        <td>${d.date} <br> <small>${d.time}</small></td>
                        <td>${d.room}</td>
                        <td style="text-align:center;">
                            <button class="btn btn-sm btn-danger" onclick="deleteDuty(${d.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>`;
                });
            } catch (err) {
                console.error(err);
            }
        }

        async function updateRoom(e) {
            e.preventDefault();
            const notificationBox = document.getElementById('edit-notification');
            const data = {
                room_id: document.getElementById('edit_room_id').value,
                rows: document.getElementById('edit_rows').value,
                cols: document.getElementById('edit_cols').value
            };
            const res = await fetch('/api/admin/update-room', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            const result = await res.json();
            notificationBox.style.display = 'block';
            if (result.status === 'success') {
                notificationBox.className = 'alert alert-success';
                notificationBox.innerText = "‚úÖ " + result.message;
                setTimeout(() => location.reload(), 2000);
            } else {
                notificationBox.className = 'alert alert-danger';
                notificationBox.innerText = "Error: " + (result.message || result.error);
            }
        }

        function generateLayoutGrid() {
            const rows = parseInt(document.getElementById('rows').value);
            const cols = parseInt(document.getElementById('cols').value);
            const grid = document.getElementById('layout-preview');
            const container = document.getElementById('layout-container');
            grid.innerHTML = '';
            grid.style.gridTemplateColumns = `repeat(${cols}, 40px)`;
            layoutState = [];
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    const idx = (r * cols) + c;
                    layoutState.push(1);
                    const box = document.createElement('div');
                    box.className = 'layout-box';
                    box.innerText = `${r + 1}-${c + 1}`;
                    box.onclick = function() {
                        if (layoutState[idx] === 1) {
                            layoutState[idx] = 0;
                            box.classList.add('disabled');
                        } else {
                            layoutState[idx] = 1;
                            box.classList.remove('disabled');
                        }
                    };
                    grid.appendChild(box);
                }
            }
            container.style.display = 'block';
        }

        async function addRoom(e) {
            e.preventDefault();
            const data = {
                building: document.getElementById('building_name').value,
                name: document.getElementById('room_name').value,
                rows: document.getElementById('rows').value,
                cols: document.getElementById('cols').value,
                layout_matrix: layoutState.join(',')
            };
            const res = await fetch('/api/admin/add-room', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            const result = await res.json();
            alert(result.message);
            location.reload();
        }

        async function updateStats() {
            const roomSelect = document.getElementById('target_room_id');
            const selectedOption = roomSelect.options[roomSelect.selectedIndex];

            let capacity = 0;
            if (roomSelect.value === 'all') {
                capacity = "MAX (All Rooms)";
            } else {
                capacity = parseInt(selectedOption.getAttribute('data-capacity')) || 0;
            }

            document.getElementById('stat_room_cap').innerText = capacity;

            const sessionVal = document.getElementById('target_session').value;
            const branchVal = document.getElementById('branches_input').value;

            if (!sessionVal) return;

            try {
                const payload = {
                    session: sessionVal,
                    branches: branchVal
                };
                const res = await fetch('/api/admin/student-stats', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();

                document.getElementById('stat_selected').innerText = data.matching_students;

                const breakdownDiv = document.getElementById('stat_breakdown');
                breakdownDiv.innerHTML = '';
                if (Object.keys(data.branch_breakdown).length > 0) {
                    for (const [branch, count] of Object.entries(data.branch_breakdown)) {
                        breakdownDiv.innerHTML += `<span class="badge bg-white text-primary border border-primary">${branch}: ${count}</span> `;
                    }
                }

                const statusEl = document.getElementById('stat_status');

                if (roomSelect.value === 'all') {
                    statusEl.innerHTML = `<span style="color: blue">‚ÑπÔ∏è Auto-Allocation Mode</span>`;
                } else if (capacity > 0) {
                    const diff = capacity - data.matching_students;
                    if (diff >= 0) statusEl.innerHTML = `<span style="color: green">‚úÖ Fits! (${diff})</span>`;
                    else statusEl.innerHTML = `<span style="color: red">‚ùå Overflow! (${Math.abs(diff)})</span>`;
                } else {
                    statusEl.innerText = "Select Room";
                }
            } catch (err) {
                console.error(err);
            }
        }

        async function uploadCSV(e) {
            e.preventDefault();
            const fileInput = document.getElementById('csv_file');
            const status = document.getElementById('upload-status');
            status.style.display = 'block';
            if (fileInput.files.length === 0) return alert("Select a file!");
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            status.innerHTML = "Uploading...";
            try {
                const res = await fetch('/api/admin/bulk-upload', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                status.innerHTML = res.ok ? `‚úÖ ${data.message}` : `‚ùå ${data.error}`;
                loadStudents(); // Refresh list after upload
            } catch (err) {
                status.innerHTML = "‚ùå Upload Failed";
            }
        }

        // REPLACE existing fetchExamTimesForAttendance function
        async function fetchExamTimesForAttendance() {
            const date = document.getElementById('att_date').value;
            const timeSelect = document.getElementById('att_time'); // We will reuse this ID for the Exam Dropdown

            // Reset dropdown
            timeSelect.innerHTML = '<option value="">Loading...</option>';

            if (!date) {
                timeSelect.innerHTML = '<option value="">-- Select Date First --</option>';
                return;
            }

            try {
                // CALL NEW ENDPOINT
                const res = await fetch(`/api/admin/get-exams-on-date?date=${date}`);
                const exams = await res.json();

                timeSelect.innerHTML = '';

                if (exams.length === 0) {
                    timeSelect.innerHTML = '<option value="">No exams found on this date</option>';
                } else {
                    timeSelect.innerHTML = '<option value="">-- Select Exam Session --</option>';
                    // Populate with ID as value, and Label (Time + Batch) as text
                    exams.forEach(ex => {
                        const opt = document.createElement('option');
                        opt.value = ex.id; // This sends the specific Exam ID
                        opt.text = ex.label; // This shows "10:00 AM | Name | Batch: 2024..."
                        timeSelect.appendChild(opt);
                    });
                }
            } catch (err) {
                console.error(err);
                timeSelect.innerHTML = '<option value="">Error fetching exams</option>';
            }
        }

        async function generateSeating(e) {
            e.preventDefault();
            const btn = document.querySelector('#seatingForm button[type="submit"]');
            const originalText = btn.innerText;
            btn.innerText = "Processing... (This may take time)";
            btn.disabled = true;

            const data = {
                room_id: document.getElementById('target_room_id').value,
                exam_name: document.getElementById('exam_name').value,
                branches: document.getElementById('branches_input').value,
                date: document.getElementById('exam_date').value,
                time: document.getElementById('exam_time').value,
                target_session: document.getElementById('target_session').value,
                semester: document.getElementById('gen_semester').value,
                max_branches: document.getElementById('max_branches').value
            };

            try {
                const res = await fetch('/api/admin/generate-seating', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                const box = document.getElementById('seating-result');
                box.style.display = 'block';
                if (result.success) {
                    box.innerHTML = `‚úÖ ${result.message || 'Success!'}`;
                    box.style.color = 'green';
                } else {
                    box.innerHTML = `‚ùå Error: ${result.error}`;
                    box.style.color = 'red';
                }
            } catch (err) {
                alert("Server Error");
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        async function fetchExamsForRoom() {
            const roomId = document.getElementById('chart_room_id').value;
            const examSelect = document.getElementById('chart_exam_id');
            examSelect.innerHTML = '<option value="">Loading...</option>';
            examSelect.disabled = true;

            // Allow "0" (All Rooms) but reject empty string
            if (roomId === "") return;

            try {
                const res = await fetch(`/api/admin/get-exams-in-room/${roomId}`);
                const exams = await res.json();
                examSelect.innerHTML = '<option value="">-- Select Session --</option>';
                exams.forEach(ex => {
                    const option = document.createElement('option');
                    option.value = ex.id;
                    option.text = ex.name;
                    examSelect.appendChild(option);
                });
                examSelect.disabled = false;
            } catch (e) {
                examSelect.innerHTML = '<option>Error</option>';
            }
        }

        async function fetchExamsForDuty() {
            const roomId = document.getElementById('duty_room_id').value;
            const select = document.getElementById('duty_exam_id');
            select.innerHTML = '<option>Loading...</option>';
            select.disabled = true;
            if (!roomId) return;
            try {
                const res = await fetch(`/api/admin/get-exams-in-room/${roomId}`);
                const exams = await res.json();
                select.innerHTML = '<option value="">-- Select Exam --</option>';
                exams.forEach(ex => {
                    const opt = document.createElement('option');
                    opt.value = ex.id;
                    opt.text = ex.name;
                    select.appendChild(opt);
                });
                select.disabled = false;
            } catch (e) {
                select.innerHTML = '<option>Error</option>';
            }
        }

        async function loadChart() {
            const roomId = document.getElementById('chart_room_id').value;
            const examId = document.getElementById('chart_exam_id').value;
            if (!roomId && roomId !== "0") return alert("Select a Room");
            if (!examId) return alert("Select an Exam Session");

            try {
                const res = await fetch(`/api/admin/get-seating-chart/${roomId}?exam_id=${examId}`);
                const data = await res.json();
                const container = document.getElementById('seating-grid');
                container.innerHTML = '';

                const renderGrid = (roomData, isMulti) => {
                    const wrapper = document.createElement('div');
                    wrapper.style.marginBottom = '40px';
                    wrapper.style.pageBreakInside = 'avoid';

                    if (isMulti) {
                        const title = document.createElement('h3');
                        title.innerText = roomData.room_name;
                        title.style.borderBottom = "2px solid #ccc";
                        title.style.paddingBottom = "5px";
                        wrapper.appendChild(title);
                    }

                    const grid = document.createElement('div');
                    grid.style.display = 'grid';
                    grid.style.gap = '10px';
                    grid.style.gridTemplateColumns = `repeat(${roomData.cols}, 1fr)`;

                    const seatMap = {};
                    roomData.seats.forEach(s => {
                        let r = s.row;
                        let c = s.col;
                        if (s.label) {
                            const m = s.label.match(/R(\d+)-C(\d+)/);
                            if (m) {
                                r = parseInt(m[1]);
                                c = parseInt(m[2]);
                            }
                        }
                        seatMap[`${r}-${c}`] = s;
                    });

                    for (let r = 1; r <= roomData.rows; r++) {
                        for (let c = 1; c <= roomData.cols; c++) {
                            const seatBox = document.createElement('div');
                            const student = seatMap[`${r}-${c}`];
                            seatBox.style.padding = '15px';
                            seatBox.style.borderRadius = '8px';
                            seatBox.style.background = '#f3f4f6';
                            seatBox.style.border = '1px solid #ddd';
                            seatBox.style.textAlign = 'center';
                            seatBox.innerHTML = `<small style="color:#999">R${r}-C${c}</small>`;

                            if (student) {
                                // --- NEW PDF STYLE START ---

                                // 1. Box Styling: White background, Black border, Square corners
                                seatBox.style.background = '#ffffff';
                                seatBox.style.border = '1px solid #000';
                                seatBox.style.color = '#000';
                                seatBox.style.borderRadius = '0'; // Square corners like a table
                                seatBox.style.padding = '4px'; // Reduce padding for compact look

                                // 2. Content Layout: Matches the PDF text order
                                seatBox.innerHTML = `
        <div style="font-weight: bold; font-size: 13px; line-height: 1.2;">
            ${student.reg_no}
        </div>
        <div style="font-weight: bold; font-size: 12px; margin: 2px 0;">
            ${student.branch}
        </div>
        <div style="font-size: 10px; color: #444; border-top: 1px solid #eee; margin-top: 2px; padding-top: 2px;">
            ${student.label} </div>
    `;

                                // Optional: Flexbox to center content nicely
                                seatBox.style.display = 'flex';
                                seatBox.style.flexDirection = 'column';
                                seatBox.style.justifyContent = 'center';

                                // --- NEW PDF STYLE END ---
                            } else {
                                // Empty Seat Styling (keep it subtle)
                                seatBox.style.background = '#f9f9f9';
                                seatBox.style.border = '1px dashed #ccc';
                                seatBox.style.borderRadius = '0';
                            }
                            grid.appendChild(seatBox);
                        }
                    }
                    wrapper.appendChild(grid);
                    container.appendChild(wrapper);
                };

                if (data.mode === 'multi') {
                    if (data.rooms.length === 0) container.innerHTML = "<p>No students assigned to any room for this exam.</p>";
                    data.rooms.forEach(r => renderGrid(r, true));
                } else {
                    renderGrid(data, false);
                }

            } catch (err) {
                console.error(err);
                alert("Error loading chart.");
            }
        }

        async function downloadPDF() {
            // 1. Get Data from Screen
            const gridElement = document.getElementById('seating-grid');
            const roomSelect = document.getElementById('chart_room_id');
            const roomName = roomSelect.options[roomSelect.selectedIndex].text;
            const examText = document.getElementById('chart_exam_id').options[document.getElementById('chart_exam_id').selectedIndex].text;

            if (!gridElement.innerHTML.trim()) return alert("Load a chart first!");

            // 2. Create a Temp Container for PDF Generation
            const pdfContainer = document.createElement('div');
            pdfContainer.id = "pdf-gen-container";
            // A4 Landscape Dimensions (approx)
            pdfContainer.style.width = '1100px';
            pdfContainer.style.margin = '0 auto';
            pdfContainer.style.backgroundColor = '#ffffff';
            pdfContainer.style.padding = '20px';
            pdfContainer.style.fontFamily = 'Arial, sans-serif';
            pdfContainer.style.color = '#000';

            // 3. Add Main Header
            const header = document.createElement('div');
            header.style.textAlign = 'center';
            header.style.marginBottom = '20px';
            header.innerHTML = `
                <h2 style="margin:0; text-transform:uppercase;">${roomName}</h2>
                <h3 style="margin:5px 0; text-decoration:underline;">EXAMINATION SEATING PLAN</h3>
                <p style="margin:5px 0; font-weight:bold;">${examText}</p>
            `;
            pdfContainer.appendChild(header);

            // 4. Extract Data from the Visual Grid and Convert to Tables
            // We look for wrappers (which represent rooms)
            const wrappers = gridElement.children;

            Array.from(wrappers).forEach(wrapper => {
                // If there is a title (Multi-Room view), add it
                const title = wrapper.querySelector('h3');
                if (title) {
                    const roomTitle = document.createElement('h4');
                    roomTitle.innerText = title.innerText;
                    roomTitle.style.marginTop = "20px";
                    roomTitle.style.marginBottom = "10px";
                    roomTitle.style.borderBottom = "1px solid #000";
                    pdfContainer.appendChild(roomTitle);
                }

                // Find the actual grid div
                const gridDiv = wrapper.querySelector('div[style*="display: grid"]');
                if (!gridDiv) return;

                // Determine columns (from CSS style or default to 6)
                const styleTemplate = gridDiv.style.gridTemplateColumns;
                const colMatch = styleTemplate ? styleTemplate.match(/repeat\((\d+)/) : null;
                const colCount = colMatch ? parseInt(colMatch[1]) : 6;

                // Create a Table for Stability
                const table = document.createElement('table');
                table.style.width = '100%';
                table.style.borderCollapse = 'separate';
                table.style.borderSpacing = '10px'; // Gap between seats
                table.style.marginBottom = '20px';
                table.style.pageBreakInside = 'avoid';

                const seats = Array.from(gridDiv.children);
                let currentRow = null;

                seats.forEach((seatDiv, index) => {
                    // Start a new row every 'colCount' items
                    if (index % colCount === 0) {
                        currentRow = table.insertRow();
                    }

                    const cell = currentRow.insertCell();
                    cell.style.verticalAlign = 'middle';
                    cell.style.width = `${100 / colCount}%`; // Distribute width evenly

                    // Build Seat Box (Oval Shape)
                    const box = document.createElement('div');

                    // -- STYLE MATCHING THE PDF --
                    box.style.border = '1px solid #000';
                    box.style.borderRadius = '50px'; // Makes it oval
                    box.style.padding = '8px 4px';
                    box.style.textAlign = 'center';
                    box.style.minHeight = '55px';
                    box.style.display = 'flex';
                    box.style.flexDirection = 'column';
                    box.style.justifyContent = 'center';
                    box.style.alignItems = 'center';

                    // Clean HTML content (remove old styles/classes)
                    // The content inside seatDiv usually looks like:
                    // <div>RegNo</div><div>Branch</div><div>Label</div>

                    // We parse the text content manually to ensure clean formatting
                    const lines = seatDiv.innerText.split('\n').filter(l => l.trim() !== '');

                    if (lines.length >= 3) {
                        // Occupied Seat
                        const regNo = lines[0]; // Roll/Reg No
                        const branch = lines[1]; // Branch
                        const label = lines[lines.length - 1]; // R1-C1 (Last item)

                        box.innerHTML = `
                            <div style="font-weight:bold; font-size:11px; line-height:1.2;">${regNo}</div>
                            <div style="font-weight:bold; font-size:10px; line-height:1.2;">${branch}</div>
                            <div style="font-size:9px; margin-top:2px;">${label}</div>
                        `;
                    } else {
                        // Empty Seat
                        box.style.border = '1px dashed #ccc';
                        box.style.color = '#ccc';
                        box.innerHTML = `<div style="font-size:9px;">${seatDiv.innerText}</div>`;
                    }

                    cell.appendChild(box);
                });

                pdfContainer.appendChild(table);
            });

            // 5. Append to body temporarily (hidden from view but rendered)
            const originalScroll = window.scrollY;
            document.querySelector('.sidebar').style.display = 'none';
            document.querySelector('.main-content').style.display = 'none';
            document.body.appendChild(pdfContainer);

            // 6. Generate PDF
            const opt = {
                margin: [10, 10, 10, 10], // mm
                filename: `Seating_Plan_${roomName.replace(/\s+/g, '_')}.pdf`,
                image: {
                    type: 'jpeg',
                    quality: 0.98
                },
                html2canvas: {
                    scale: 2,
                    useCORS: true
                }, // Higher scale for clear text
                jsPDF: {
                    unit: 'mm',
                    format: 'a4',
                    orientation: 'landscape'
                }
            };

            try {
                await html2pdf().set(opt).from(pdfContainer).save();
            } catch (err) {
                console.error(err);
                alert("Error generating PDF");
            } finally {
                // 7. Cleanup
                document.body.removeChild(pdfContainer);
                document.querySelector('.sidebar').style.display = '';
                document.querySelector('.main-content').style.display = '';
                window.scrollTo(0, originalScroll);
            }
        }


        async function trainAI() {
            const status = document.getElementById('ai-status');
            status.style.display = 'block';
            status.innerText = "Training...";
            const res = await fetch('/api/admin/train-ai');
            const data = await res.json();
            status.innerText = "‚úÖ " + data.message;
        }

        async function addTeacher(e) {
            e.preventDefault();
            const data = {
                name: document.getElementById('teach_name').value,
                employee_id: document.getElementById('teach_id').value,
                branch: document.getElementById('teach_branch').value,
                email: document.getElementById('teach_email').value
            };
            const res = await fetch('/api/admin/add-teacher', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            const json = await res.json();
            alert(json.message || json.error);
            loadTeachers();
        }

        async function deleteTeacher(id) {
            if (!confirm("Are you sure you want to remove this teacher?")) return;
            try {
                const res = await fetch('/api/admin/delete-teacher', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        teacher_id: id
                    })
                });
                const result = await res.json();
                if (res.ok) {
                    loadTeachers(); // Reload list
                } else {
                    alert("Error: " + result.error);
                }
            } catch (e) {
                console.error(e);
            }
        }

        async function assignDuty(e) {
            e.preventDefault();
            const data = {
                room_id: document.getElementById('duty_room_id').value,
                exam_id: document.getElementById('duty_exam_id').value,
                teacher_id: document.getElementById('duty_teacher_id').value
            };
            const res = await fetch('/api/admin/assign-invigilator', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            const json = await res.json();
            alert(json.message || json.error);
            loadDuties();
        }

        async function deleteDuty(dutyId) {
            if (!confirm("Are you sure you want to remove this duty?")) return;
            try {
                const res = await fetch('/api/admin/delete-duty', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        duty_id: dutyId
                    })
                });
                const data = await res.json();
                if (res.ok) {
                    loadDuties();
                } else {
                    alert("Error: " + data.error);
                }
            } catch (err) {
                alert("Failed to delete duty.");
            }
        }

        async function generateNotice() {
            const date = document.getElementById('notice_date').value;
            const time = document.getElementById('notice_time').value;
            const batch = document.getElementById('notice_batch').value;
            const roomId = document.getElementById('notice_room_id').value;
            const semester = document.getElementById('notice_semester').value;

            // 1. Get the ID Type (Reg No or Roll No)
            const idType = document.getElementById('notice_id_type').value;

            if (!date || !time) return alert("Please select Date and Time");

            try {
                // 2. Pass 'id_type' to the API
                const res = await fetch(`/api/admin/notice-board-data?exam_id=${time}&date=${date}&batch=${batch}&room_id=${roomId}&semester=${semester}&id_type=${idType}`);
                const json = await res.json();

                if (json.error) return alert(json.error);

                let title = json.exam_info.title + ` (${json.exam_info.date})`;
                if (json.exam_info.semester) {
                    title = `${json.exam_info.semester} ${title}`;
                }
                if (json.exam_info.batch && json.exam_info.batch !== "All Batches") {
                    title += ` - Batch ${json.exam_info.batch}`;
                }

                document.getElementById('notice-exam-title').innerText = title;
                document.getElementById('notice-timing').innerText = json.exam_info.time;

                // 3. Determine Table Header Text
                const headerText = idType === 'reg' ? "REGISTRATION NUMBER" : "ROLL NUMBER";

                // Update the Table Header HTML
                const tableHead = document.querySelector('.notice-table thead');
                tableHead.innerHTML = `
                    <tr>
                        <th style="width: 25%;">BRANCH</th>
                        <th style="width: 55%;">${headerText}</th>
                        <th style="width: 20%;">HALL NO.</th>
                    </tr>
                `;

                const tbody = document.getElementById('notice-body');
                tbody.innerHTML = '';
                let grandTotal = 0;

                json.data.forEach(room => {
                    const branches = room.branches;
                    const rowsNeeded = branches.length + 1;

                    let firstBranch = branches[0];
                    let html = `
                        <tr>
                            <td><strong>${firstBranch.name}</strong></td>
                            <td>
                                <div class="range-cell">
                                    <span>${firstBranch.range}</span>
                                    <span>= ${firstBranch.count}</span>
                                </div>
                            </td>
                            <td rowspan="${rowsNeeded}" class="hall-cell" style="background:#fff;">
                                ${room.hall_no}
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += html;

                    for (let i = 1; i < branches.length; i++) {
                        let b = branches[i];
                        tbody.innerHTML += `
                            <tr>
                                <td><strong>${b.name}</strong></td>
                                <td>
                                    <div class="range-cell">
                                        <span>${b.range}</span>
                                        <span>= ${b.count}</span>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }

                    tbody.innerHTML += `
                        <tr style="background-color: #fcfcfc;">
                            <td></td>
                            <td class="total-row">Room Total = ${room.room_total}</td>
                        </tr>
                    `;

                    grandTotal += room.room_total;
                });

                tbody.innerHTML += `
                    <tr class="grand-total" style="background-color: #e5e7eb; border-top: 2px solid #000;">
                        <td colspan="2" style="text-align:right; padding-right:20px; font-size: 16px;">
                            <strong>GRAND TOTAL</strong>
                        </td>
                        <td style="text-align:center; font-size: 16px;">
                            <strong>${grandTotal}</strong>
                        </td>
                    </tr>
                `;

                document.getElementById('notice-container').style.display = 'block';

            } catch (e) {
                console.error(e);
                alert("Error fetching data");
            }
        }

        function printNotice() {
            const element = document.getElementById('notice-container');
            if (element.style.display === 'none') return alert("Generate the notice first!");
            window.print();
        }

        function printSection(elementId) {
            const content = document.getElementById(elementId);
            if (!content || content.innerHTML.trim() === "" || content.style.display === 'none') {
                alert("Nothing to print! Please generate the sheet first.");
                return;
            }

            const printWindow = window.open('', '', 'height=800,width=1000');
            printWindow.document.write('<html><head><title>Print View</title>');

            const styles = document.querySelectorAll('style, link[rel="stylesheet"]');
            styles.forEach(style => {
                printWindow.document.write(style.outerHTML);
            });

            printWindow.document.write(`
                <style> 
                    body { display: block !important; background: white !important; padding: 0 !important; margin: 0 !important; height: auto !important; overflow: visible !important; } 
                    .att-sheet, #distribution-preview, #master-chart-preview { display: block !important; width: 100% !important; height: auto !important; margin: 0 0 20px 0 !important; page-break-after: always !important; box-shadow: none !important; }
                    .att-sheet:last-child { page-break-after: auto !important; }
                </style>
            `);

            printWindow.document.write('</head><body>');
            printWindow.document.write(content.innerHTML);
            printWindow.document.write('</body></html>');

            printWindow.document.close();
            printWindow.focus();

            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 500);
        }

        async function generateAttendance() {
            const date = document.getElementById('att_date').value;
            const time = document.getElementById('att_time').value;
            const roomId = document.getElementById('att_room_id').value;
            const subjectCount = parseInt(document.getElementById('att_subject_count').value);

            if (!date || !time || !roomId) return alert("Fill all fields");

            let headerRow1 = '';
            let headerRow2 = '';

            // Generate header columns for subjects
            for (let i = 0; i < subjectCount; i++) {
                headerRow1 += `<th colspan="2" style="padding: 8px;">Date: .......................<br>Subject: ....................</th>`;
                headerRow2 += `<th style="padding: 8px;">Book. No.</th><th style="padding: 8px;">Signature</th>`;
            }

            // Generate empty grid cells for the footer rows (merged 2-by-2 for valid signature space)
            const footerEmptyCells = Array(subjectCount).fill('<td colspan="2" style="border: 1px solid black;"></td>').join('');

            try {
                // Encode time to safely handle spaces/special chars
                const res = await fetch(`/api/admin/attendance-sheet-data?exam_id=${encodeURIComponent(time)}&room_id=${roomId}`);
                const json = await res.json();

                if (json.error) return alert(json.error);
                if (!json.sheets || json.sheets.length === 0) return alert("No students found for this time slot.");

                const container = document.getElementById('attendance-preview');
                container.innerHTML = '';

                json.sheets.forEach(sheet => {
                            // Generate empty cells for student rows
                            let emptyBodyCells = '';
                            for (let i = 0; i < subjectCount; i++) {
                                emptyBodyCells += '<td style="border: 1px solid black;"></td><td style="border: 1px solid black;"></td>';
                            }

                            const html = `
                    <div class="att-sheet" style="padding: 30px; font-family: 'Times New Roman', serif;">
                        <div class="att-title" style="font-size: 24px; font-weight: bold; text-align: center; text-decoration: underline; margin-bottom: 5px;">ATTENDANCE SHEET</div>
                        <div class="att-sub" style="font-size: 18px; font-weight: bold; text-align: center;">JUT, RANCHI</div>
                        <div class="att-sub" style="font-size: 18px; font-weight: bold; text-align: center;">B.I.T. SINDRI</div>
                        <div class="att-sub" style="font-size: 18px; font-weight: bold; text-align: center; margin-bottom: 20px;">EXAMINATION SECTION</div>
                        
                        <div style="text-align: right; font-weight: bold; font-size: 16px; margin-bottom: 10px;">Hall No. ${sheet.hall_no}</div>
                        
                        <table class="att-meta" style="width:100%; font-weight:bold; font-size:16px; margin-bottom:20px;">
                            <tr><td style="padding: 4px 0;">Name of Examination: ${sheet.exam_name}</td><td style="text-align:right">Session: ${sheet.semester}</td></tr>
                            <tr><td style="padding: 4px 0;">Name of Institute: B.I.T. Sindri</td><td style="text-align:right">Centre: B.I.T.</td></tr>
                            <tr><td style="padding: 4px 0;">Course: B. Tech</td><td style="text-align:right">Branch: ${sheet.branch}</td></tr>
                        </table>

                        <table class="att-table" style="width: 100%; border-collapse: collapse; font-size: 14px;">
                            <thead>
                                <tr>
                                    <th rowspan="2" style="width: 5%; border: 1px solid black; padding: 8px;">Sl.<br>No.</th>
                                    <th rowspan="2" style="width: 15%; border: 1px solid black; padding: 8px;">Reg No</th>
                                    <th rowspan="2" style="width: 20%; border: 1px solid black; padding: 8px;">Name</th>
                                    ${headerRow1}
                                </tr>
                                <tr>${headerRow2}</tr>
                            </thead>
                            <tbody>
                                ${sheet.students.map(s => `
                                    <tr>
                                        <td style="text-align:center; padding: 10px 5px; border: 1px solid black;">${s.sl}</td>
                                        <td style="text-align:center; padding: 10px 5px; border: 1px solid black;">${s.reg_no || 'N/A'}</td>
                                        <td class="att-left" style="padding: 10px 5px; text-align: left; border: 1px solid black;">${s.name}</td>
                                        ${emptyBodyCells}
                                    </tr>
                                `).join('')}
                                
                                <tr style="height: 50px;">
                                    <td colspan="3" style="text-align: right; font-weight: bold; font-size: 15px; padding: 10px; border: 1px solid black;">Total No. of Students &rarr;</td>
                                    ${footerEmptyCells}
                                </tr>
                                
                                <tr style="height: 50px;">
                                    <td colspan="3" style="text-align: right; font-weight: bold; font-size: 15px; padding: 10px; border: 1px solid black;">Signature of Invigilator &rarr;</td>
                                    ${footerEmptyCells}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    `;
                        container.innerHTML += html;
                    });

                    document.getElementById('attendance-preview').style.display = 'block';

                } catch (e) {
                    console.error(e);
                    alert("Error fetching data. Ensure seating is generated first.");
                }
            }

        async function generateDistribution() {
                const date = document.getElementById('dist_date').value;
                const examId = document.getElementById('dist_time').value; // Holds Exam ID

                if (!date || !examId) return alert("Please select Date and Session");

                try {
                    // PASS exam_id parameter
                    const res = await fetch(`/api/admin/question-distribution?exam_id=${examId}&date=${date}`);
                    const json = await res.json();

                    if (json.error) return alert(json.error);

                    document.getElementById('dist-exam-name').innerText = json.exam.name;
                    document.getElementById('dist-exam-time').innerText = json.exam.time;

                    const tbody = document.getElementById('dist-body');
                    tbody.innerHTML = '';
                    let sl = 1;

                    json.data.forEach(row => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                <td style="text-align: center; font-weight: bold;">${sl++}</td>
                <td style="font-weight: bold; text-align: center;">${row.branch}</td>
                <td style="font-weight: bold; padding-left: 15px;">
                    ${row.breakdown} 
                    <span style="float: right; margin-right: 10px; background: #eee; padding: 0 5px; border: 1px solid #ccc;">
                        Total: ${row.total}
                    </span>
                </td>
            `;
                        tbody.appendChild(tr);
                    });
                    document.getElementById('distribution-preview').style.display = 'block';
                } catch (e) { console.error(e); alert("Error generating chart."); }
            }

            async function generateMasterChart() {
                    const date = document.getElementById('master_date').value;
                    const examId = document.getElementById('master_time').value; // Holds Exam ID

                    if (!date || !examId) return alert("Select Date and Session");

                    try {
                        // PASS exam_id parameter
                        const res = await fetch(`/api/admin/master-chart?exam_id=${examId}&date=${date}`);
                        const json = await res.json();

                        if (json.error) return alert(json.error);

                        document.getElementById('master-exam-title').innerText = json.exam_title;
                        document.getElementById('master-exam-timing').innerText = json.timing;
                        document.getElementById('master-total-present').innerText = json.grand_total;

                        const thead = document.getElementById('master-table-head');
                        let headerHTML = `
            <th style="width: 15%;">Hall No.</th>
            <th style="width: 15%;">Branch's</th>
            <th style="width: 10%;">Total Student</th>
        `;
                        json.date_headers.forEach(d => { headerHTML += `<th>${d}</th>`; });
                        thead.innerHTML = headerHTML;

                        const tbody = document.getElementById('master-table-body');
                        tbody.innerHTML = '';
                        const emptyDateCells = json.date_headers.map(() => '<td></td>').join('');

                        json.data.forEach(room => {
                            const branches = room.branches;
                            const rows = branches.length;
                            let firstBranch = branches[0];

                            tbody.innerHTML += `
                <tr>
                    <td rowspan="${rows}" style="background: #fff; vertical-align: middle; font-weight: bold; font-size: 15px;">${room.hall_no}</td>
                    <td style="font-weight: bold;">${firstBranch.name}</td>
                    <td style="font-weight: bold;">${firstBranch.count}</td>
                    ${emptyDateCells}
                </tr>
            `;

                            for (let i = 1; i < branches.length; i++) {
                                tbody.innerHTML += `
                    <tr>
                        <td style="font-weight: bold;">${branches[i].name}</td>
                        <td style="font-weight: bold;">${branches[i].count}</td>
                        ${emptyDateCells}
                    </tr>
                `;
                            }
                        });
                        document.getElementById('master-chart-preview').style.display = 'block';
                    } catch (e) { console.error(e); alert("Error generating Master Chart"); }
                }

        async function resetSystem() {
            if (!confirm("‚ö†Ô∏è SAFE RESET ‚ö†Ô∏è\n\nAre you sure you want to WIPE EXAM DATA?\n\nThis will delete:\n- All Seating Arrangements\n- All Exam Schedules\n- All Distribution Charts\n\n(Students & Teachers remain safe)")) return;

            try {
                const res = await fetch('/api/admin/reset-seating', { method: 'POST' });
                const json = await res.json();
                if (json.success) {
                    alert("‚úÖ System Reset Successfully!");
                    location.reload();
                } else {
                    alert("‚ùå Error: " + json.error);
                }
            } catch (e) {
                alert("‚ùå Request Failed");
            }
        }

        async function resetDatabase() {
            const conf = prompt("Type 'DELETE' to confirm wiping ALL DATA (Students, Rooms, Exams, Teachers). This cannot be undone.");
            if (conf !== 'DELETE') return alert("Cancelled.");
            try {
                const res = await fetch('/api/admin/reset-database', { method: 'POST' });
                const data = await res.json();
                if (res.ok) { alert(data.message); location.reload(); }
                else alert(data.error);
            } catch (e) { alert("Reset Failed"); }
        }

        /* --- STUDENT CRUD FUNCTIONS (Ported from Old File) --- */
        async function loadStudents() {
                const tbody = document.getElementById('student-table-body');
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center">Loading...</td></tr>';

                try {
                    const res = await fetch('/api/admin/get-all-students');
                    allStudents = await res.json();

                    // Call the function to fill the dropdown
                    populateSessionFilter();

                    renderStudentTable(allStudents);
                } catch (err) {
                    console.error(err);
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:red;">Error loading data</td></tr>';
                }
            }

            function renderStudentTable(data) {
                    const tbody = document.getElementById('student-table-body');
                    tbody.innerHTML = '';

                    if (data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center">No students found. Add one manually or upload CSV.</td></tr>';
                        return;
                    }

                    data.forEach(student => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
            <td>${student.name}</td>
            <td><strong>${student.reg_no}</strong></td> <td><span class="badge" style="background:#e0e7ff; color:#3730a3;">${student.branch}</span></td>
            <td>${student.session || '-'}</td>
            <td>
                <button onclick="editStudent('${student.id}')" class="btn btn-sm btn-warning" style="padding: 5px 10px;"><i class="fas fa-edit"></i></button>
                <button onclick="deleteStudent('${student.id}')" class="btn btn-sm btn-danger" style="padding: 5px 10px;"><i class="fas fa-trash"></i></button>
            </td>
        `;
                        tbody.appendChild(tr);
                    });
                }

        function toggleStudentForm(reset = true) {
            const formContainer = document.getElementById('student-form-container');
            const isVisible = formContainer.style.display === 'block';
            formContainer.style.display = isVisible ? 'none' : 'block';
            if (reset && !isVisible) {
                document.getElementById('form-title').innerText = "Add Student";
                document.getElementById('stud_id').value = "";
                document.getElementById('stud_name').value = "";
                document.getElementById('stud_roll').value = "";
                document.getElementById('stud_reg_no').value = "";
                document.getElementById('stud_branch').value = "";
                document.getElementById('stud_session').value = "";
                document.getElementById('save-btn').innerText = "Save Student";
            }
        }

        function editStudent(id) {
            const student = allStudents.find(s => s.id == id);
            if (!student) return;
            toggleStudentForm(false);
            document.getElementById('form-title').innerText = "Edit Student Details";
            document.getElementById('stud_id').value = student.id;
            document.getElementById('stud_name').value = student.name;
            document.getElementById('stud_reg_no').value = student.reg_no || student.roll_no;
            document.getElementById('stud_roll').value = student.roll_no;
            document.getElementById('stud_branch').value = student.branch;
            document.getElementById('stud_session').value = student.session;
            document.getElementById('save-btn').innerText = "Update Student";
            document.getElementById('student-form-container').scrollIntoView({ behavior: 'smooth' });
        }

        async function handleStudentSave(e) {
            e.preventDefault();
            const id = document.getElementById('stud_id').value;
            // Get values
            const rollNo = document.getElementById('stud_roll').value;
            let regNo = document.getElementById('stud_reg_no').value;

            // Fallback: If Reg No is empty, use Roll No
            if (!regNo || regNo.trim() === "") {
                regNo = rollNo;
            }
            const data = {
                name: document.getElementById('stud_name').value,
                roll_no: document.getElementById('stud_roll').value,
                registration_number: regNo,
                branch: document.getElementById('stud_branch').value,
                session: document.getElementById('stud_session').value
            };
            const url = id ? '/api/admin/update-student' : '/api/admin/add-student';
            if (id) data.id = id;

            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();

                if (result.status === 'success' || res.ok) {
                    alert(id ? "Student Updated!" : "Student Added!");
                    toggleStudentForm();
                    loadStudents();
                } else {
                    alert("Error: " + (result.message || "Operation failed"));
                }
            } catch (err) {
                alert("Server Error");
                console.error(err);
            }
        }

        async function deleteStudent(id) {
            if (!confirm("Are you sure you want to delete this student? This cannot be undone.")) return;
            try {
                const res = await fetch('/api/admin/delete-student', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: id })
                });
                if (res.ok) {
                    loadStudents();
                } else {
                    alert("Failed to delete student.");
                }
            } catch (err) { console.error(err); }
        }

        function filterStudents() {
                const term = document.getElementById('student_search').value.toLowerCase().trim();

                const tempCheckbox = document.getElementById('filter_temp_reg');
                const sessionSelect = document.getElementById('filter_session');

                const showTempOnly = tempCheckbox ? tempCheckbox.checked : false;
                const sessionFilter = sessionSelect ? sessionSelect.value : "";

                const filtered = allStudents.filter(s => {
                    // 1. Text Search Match (Updated to include Registration Number)
                    const s_name = (s.name || "").toLowerCase();
                    const s_roll = (s.roll_no || "").toLowerCase();
                    const s_branch = (s.branch || "").toLowerCase();
                    const s_reg_search = (s.reg_no || "").toLowerCase(); // New Check

                    const matchesText = s_name.includes(term) ||
                        s_roll.includes(term) ||
                        s_branch.includes(term) ||
                        s_reg_search.includes(term); // Included here

                    // 2. Temp ID Match
                    const s_reg = (s.reg_no || "").trim();
                    const s_roll_clean = (s.roll_no || "").trim();
                    const isTemp = (s_reg === s_roll_clean);

                    // 3. Session Match
                    const s_session = (s.session || "").trim();
                    const matchesSession = sessionFilter === "" || s_session === sessionFilter;

                    // Combine Logic
                    if (showTempOnly && !isTemp) return false;

                    return matchesText && matchesSession;
                });

                renderStudentTable(filtered);
            }

            async function fetchExamTimesForDistribution() {
                    const date = document.getElementById('dist_date').value;
                    const timeSelect = document.getElementById('dist_time');

                    timeSelect.innerHTML = '<option value="">Loading...</option>';
                    if (!date) { timeSelect.innerHTML = '<option value="">-- Select Date First --</option>'; return; }

                    try {
                        const res = await fetch(`/api/admin/get-exams-on-date?date=${date}`);
                        const exams = await res.json();
                        timeSelect.innerHTML = '';
                        if (exams.length === 0) {
                            timeSelect.innerHTML = '<option value="">No exams found</option>';
                        } else {
                            timeSelect.innerHTML = '<option value="">-- Select Session --</option>';
                            exams.forEach(ex => {
                                const opt = document.createElement('option');
                                opt.value = ex.id;      // Exam ID
                                opt.text = ex.label;    // Formatted Label
                                timeSelect.appendChild(opt);
                            });
                        }
                    } catch (err) { console.error(err); }
                }

                async function fetchExamTimesForMasterChart() {
                        const date = document.getElementById('master_date').value;
                        const timeSelect = document.getElementById('master_time');

                        timeSelect.innerHTML = '<option value="">Loading...</option>';
                        if (!date) { timeSelect.innerHTML = '<option value="">-- Select Date First --</option>'; return; }

                        try {
                            const res = await fetch(`/api/admin/get-exams-on-date?date=${date}`);
                            const exams = await res.json();
                            timeSelect.innerHTML = '';
                            if (exams.length === 0) {
                                timeSelect.innerHTML = '<option value="">No exams found</option>';
                            } else {
                                timeSelect.innerHTML = '<option value="">-- Select Session --</option>';
                                exams.forEach(ex => {
                                    const opt = document.createElement('option');
                                    opt.value = ex.id;
                                    opt.text = ex.label;
                                    timeSelect.appendChild(opt);
                                });
                            }
                        } catch (err) { console.error(err); }
                    }

                async function fetchExamTimesForNotice() {
                        const date = document.getElementById('notice_date').value;
                        const timeSelect = document.getElementById('notice_time');

                        // Reset dropdown to loading state
                        timeSelect.innerHTML = '<option value="">Loading...</option>';

                        if (!date) {
                            timeSelect.innerHTML = '<option value="">-- Select Date First --</option>';
                            return;
                        }

                        try {
                            // Reuse the same API endpoint used for other charts
                           const res = await fetch(`/api/admin/get-exams-on-date?date=${date}`);
                            const times = await res.json();

                            timeSelect.innerHTML = '';

                            if (times.length === 0) {
                                timeSelect.innerHTML = '<option value="">No exams found</option>';
                            } else {
                                timeSelect.innerHTML = '<option value="">-- Select Time --</option>';
                                times.forEach(ex => {
                                    const opt = document.createElement('option');
                                    opt.value = ex.id;
                                    opt.text = ex.label;
                                    timeSelect.appendChild(opt);
                                });
                            }
                        } catch (err) {
                            console.error(err);
                            timeSelect.innerHTML = '<option value="">Error fetching times</option>';
                        }
                    }

                    function populateSessionFilter() {
                            const filterSelect = document.getElementById('filter_session');
                            if (!filterSelect) return; // Guard clause in case element is missing

                            // Get unique sessions, remove nulls/empty, and trim spaces
                            const sessions = [...new Set(allStudents.map(s => s.session ? s.session.trim() : "").filter(s => s !== ""))].sort();

                            const currentVal = filterSelect.value;

                            filterSelect.innerHTML = '<option value="">All Sessions</option>';
                            sessions.forEach(sess => {
                                const opt = document.createElement('option');
                                opt.value = sess;
                                opt.text = sess;
                                filterSelect.appendChild(opt);
                            });

                            if (sessions.includes(currentVal)) {
                                filterSelect.value = currentVal;
                            }
                        }
                        async function deleteBatch() {
                                const session = document.getElementById('delete_target_session').value.trim();

                                if (!session) {
                                    return alert("Please enter a session/batch name (e.g. 2023-2027).");
                                }

                                const confirmMsg = `‚ö†Ô∏è DANGER ZONE ‚ö†Ô∏è\n\nAre you sure you want to delete ALL students in batch "${session}"?\n\nThis will also delete their seat assignments.\nThis action cannot be undone.`;

                                if (!confirm(confirmMsg)) return;

                                // Double confirmation for safety
                                if (!confirm(`Final Confirmation: Delete batch "${session}"?`)) return;

                                try {
                                    const res = await fetch('/api/admin/delete-students-by-session', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ session: session })
                                    });

                                    const result = await res.json();

                                    if (res.ok) {
                                        alert(result.message);
                                        document.getElementById('delete_target_session').value = ''; // Clear input
                                        loadStudents(); // Refresh table and dropdowns
                                    } else {
                                        alert("Error: " + (result.error || result.message));
                                    }
                                } catch (err) {
                                    console.error(err);
                                    alert("Server Error: Failed to delete batch.");
                                }
                            }
    </script>
</body>

</html>